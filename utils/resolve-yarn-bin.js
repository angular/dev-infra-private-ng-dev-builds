/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as fs from 'fs';
import * as path from 'path';
import which from 'which';
import { isNodeJSWrappedError } from './nodejs-errors.js';
import lockfile from '@yarnpkg/lockfile';
import { parse as parseYaml } from 'yaml';
import { ChildProcess } from './child-process.js';
import { Log } from './logging.js';
/** List of Yarn configuration files and their parsing mechanisms. */
export const yarnConfigFiles = [
    { fileName: '.yarnrc', parse: (c) => lockfile.parse(c).object },
    { fileName: '.yarnrc.yml', parse: (c) => parseYaml(c) },
];
/**
 * Resolves Yarn for the given project directory.
 *
 * This function exists so that Yarn can be invoked from within Yarn-initiated processes.
 * Yarn uses some magical logic where it creates a temporary directory to make Yarn resolvable.
 * This temporary directory is then wired up in `process.env.PATH` and can break for example
 * when a command switches branches, causing the originally invoked Yarn checked-in file to
 * become unavailable.
 */
export async function resolveYarnScriptForProject(projectDir) {
    let info;
    const yarnPathFromConfig = await getYarnPathFromConfigurationIfPresent(projectDir);
    if (yarnPathFromConfig !== null) {
        info = { binary: 'node', args: [yarnPathFromConfig] };
    }
    if (!info) {
        const yarnPathFromNpmBin = await getYarnPathFromNpmGlobalBinaries();
        if (yarnPathFromNpmBin !== null) {
            info = { binary: yarnPathFromNpmBin, args: [] };
        }
    }
    info ?? (info = { binary: 'yarn', args: [] });
    const yarnVersion = await getYarnVersion(info);
    if (yarnVersion && Number(yarnVersion.split('.')[0]) < 2) {
        info.args.push('--silent');
        info.legacy = true;
    }
    return info;
}
/** Gets the path to the Yarn binary from the NPM global binary directory. */
export async function getYarnPathFromNpmGlobalBinaries() {
    const npmGlobalBinPath = await getNpmGlobalBinPath();
    if (npmGlobalBinPath === null) {
        return null;
    }
    try {
        return await which('yarn', { path: npmGlobalBinPath });
    }
    catch (e) {
        Log.debug('Could not find Yarn within NPM global binary directory. Error:', e);
        return null;
    }
}
/** Gets the path to the system-wide global NPM binary directory. */
async function getNpmGlobalBinPath() {
    try {
        return (await ChildProcess.spawn('npm', ['bin', '--global'], { mode: 'silent' })).stdout.trim();
    }
    catch (e) {
        Log.debug('Could not determine NPM global binary directory. Error:', e);
        return null;
    }
}
/** Gets the Yarn path from the Yarn configuration if present. */
async function getYarnPathFromConfigurationIfPresent(projectDir) {
    const yarnRc = await findAndParseYarnConfiguration(projectDir);
    if (yarnRc === null) {
        return null;
    }
    const yarnPath = yarnRc['yarn-path'] ?? yarnRc['yarnPath'];
    if (yarnPath === undefined) {
        return null;
    }
    return path.resolve(projectDir, yarnPath);
}
async function getYarnVersion(info) {
    try {
        return (await ChildProcess.spawn(info.binary, [...info.args, '--version'], { mode: 'silent' })).stdout.trim();
    }
    catch (e) {
        Log.debug('Could not determine Yarn version. Error:', e);
        return null;
    }
}
/** Finds and parses the Yarn configuration file for the given project. */
async function findAndParseYarnConfiguration(projectDir) {
    const files = await Promise.all(yarnConfigFiles.map(async (entry) => ({
        entry,
        content: await readFileGracefully(path.join(projectDir, entry.fileName)),
    })));
    const config = files.find((entry) => entry.content !== null);
    if (config === undefined) {
        return null;
    }
    try {
        return config.entry.parse(config.content);
    }
    catch (e) {
        Log.debug(`Could not parse determined Yarn configuration file (${config.entry.fileName}).`);
        Log.debug(`Error:`, e);
        return null;
    }
}
/**
 * Reads the specified file gracefully.
 * @returns The file contents. Null if the file does not exist.
 */
async function readFileGracefully(filePath) {
    try {
        return await fs.promises.readFile(filePath, 'utf8');
    }
    catch (error) {
        if (isNodeJSWrappedError(error, Error) && error.code === 'ENOENT') {
            return null;
        }
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZS15YXJuLWJpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25nLWRldi91dGlscy9yZXNvbHZlLXlhcm4tYmluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUUxQixPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUN4RCxPQUFPLFFBQVEsTUFBTSxtQkFBbUIsQ0FBQztBQUN6QyxPQUFPLEVBQUMsS0FBSyxJQUFJLFNBQVMsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQWtCakMscUVBQXFFO0FBQ3JFLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBdUI7SUFDakQsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUM7SUFDN0QsRUFBQyxRQUFRLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFDO0NBQ3RELENBQUM7QUFFRjs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsMkJBQTJCLENBQUMsVUFBa0I7SUFDbEUsSUFBSSxJQUFpQyxDQUFDO0lBRXRDLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxxQ0FBcUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuRixJQUFJLGtCQUFrQixLQUFLLElBQUksRUFB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RixHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN2QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsS0FBSyxVQUFVLGtCQUFrQixDQUFDLFFBQWdCO0lBQ2hELElBQUksQ0FBQztRQUNILE9BQU8sTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixJQUFJLG9CQUFvQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ2xFLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQ1xuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB3aGljaCBmcm9tICd3aGljaCc7XG5cbmltcG9ydCB7aXNOb2RlSlNXcmFwcGVkRXJyb3J9IGZyb20gJy4vbm9kZWpzLWVycm9ycy5qcyc7XG5pbXBvcnQgbG9ja2ZpbGUgZnJvbSAnQHlhcm5wa2cvbG9ja2ZpbGUnO1xuaW1wb3J0IHtwYXJzZSBhcyBwYXJzZVlhbWx9IGZyb20gJ3lhbWwnO1xuaW1wb3J0IHtDaGlsZFByb2Nlc3N9IGZyb20gJy4vY2hpbGQtcHJvY2Vzcy5qcyc7XG5pbXBvcnQge0xvZ30gZnJvbSAnLi9sb2dnaW5nLmpzJztcblxuLyoqIFR5cGUgZGVzY3JpYmluZyBhIFlhcm4gY29uZmlndXJhdGlvbiBhbmQgaXRzIHBvdGVudGlhbCBwcm9wZXJ0aWVzLiAqL1xuZXhwb3J0IGludGVyZmFjZSBZYXJuQ29uZmlndXJhdGlvbiB7XG4gICd5YXJuUGF0aCc6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgJ3lhcm4tcGF0aCc6IHN0cmluZyB8IHVuZGVmaW5lZDtcbn1cblxuLyoqIFR5cGUgZGVzY3JpYmluZyBhIGNvbmZpZ3VyYXRpb24gd2l0aCBpdHMgY29ycmVzcG9uZGluZyBwYXJzaW5nIG1lY2hhbmlzbS4gKi9cbmV4cG9ydCB0eXBlIENvbmZpZ1dpdGhQYXJzZXIgPSB7ZmlsZU5hbWU6IHN0cmluZzsgcGFyc2U6IChjOiBzdHJpbmcpID0+IFlhcm5Db25maWd1cmF0aW9ufTtcblxuLyoqIEludGVyZmFjZSBkZXNjcmliaW5nIGEgY29tbWFuZCB0aGF0IHdpbGwgaW52b2tlIFlhcm4uICovXG5leHBvcnQgaW50ZXJmYWNlIFlhcm5Db21tYW5kSW5mbyB7XG4gIGJpbmFyeTogc3RyaW5nO1xuICBhcmdzOiBzdHJpbmdbXTtcbiAgbGVnYWN5PzogYm9vbGVhbjtcbn1cblxuLyoqIExpc3Qgb2YgWWFybiBjb25maWd1cmF0aW9uIGZpbGVzIGFuZCB0aGVpciBwYXJzaW5nIG1lY2hhbmlzbXMuICovXG5leHBvcnQgY29uc3QgeWFybkNvbmZpZ0ZpbGVzOiBDb25maWdXaXRoUGFyc2VyW10gPSBbXG4gIHtmaWxlTmFtZTogJy55YXJucmMnLCBwYXJzZTogKGMpID0+IGxvY2tmaWxlLnBhcnNlKGMpLm9iamVjdH0sXG4gIHtmaWxlTmFtZTogJy55YXJucmMueW1sJywgcGFyc2U6IChjKSA9PiBwYXJzZVlhbWwoYyl9LFxuXTtcblxuLyoqXG4gKiBSZXNvbHZlcyBZYXJuIGZvciB0aGUgZ2l2ZW4gcHJvamVjdCBkaXJlY3RvcnkuXG4gKlxuICogVGhpcyBmdW5jdGlvbiBleGlzdHMgc28gdGhhdCBZYXJuIGNhbiBiZSBpbnZva2VkIGZyb20gd2l0aGluIFlhcm4taW5pdGlhdGVkIHByb2Nlc3Nlcy5cbiAqIFlhcm4gdXNlcyBzb21lIG1hZ2ljYWwgbG9naWMgd2hlcmUgaXQgY3JlYXRlcyBhIHRlbXBvcmFyeSBkaXJlY3RvcnkgdG8gbWFrZSBZYXJuIHJlc29sdmFibGUuXG4gKiBUaGlzIHRlbXBvcmFyeSBkaXJlY3RvcnkgaXMgdGhlbiB3aXJlZCB1cCBpbiBgcHJvY2Vzcy5lbnYuUEFUSGAgYW5kIGNhbiBicmVhayBmb3IgZXhhbXBsZVxuICogd2hlbiBhIGNvbW1hbmQgc3dpdGNoZXMgYnJhbmNoZXMsIGNhdXNpbmcgdGhlIG9yaWdpbmFsbHkgaW52b2tlZCBZYXJuIGNoZWNrZWQtaW4gZmlsZSB0b1xuICogYmVjb21lIHVuYXZhaWxhYmxlLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVlhcm5TY3JpcHRGb3JQcm9qZWN0KHByb2plY3REaXI6IHN0cmluZyk6IFByb21pc2U8WWFybkNvbW1hbmRJbmZvPiB7XG4gIGxldCBpbmZvOiBZYXJuQ29tbWFuZEluZm8gfCB1bmRlZmluZWQ7XG5cbiAgY29uc3QgeWFyblBhdGhGcm9tQ29uZmlnID0gYXdhaXQgZ2V0WWFyblBhdGhGcm9tQ29uZmlndXJhdGlvbklmUHJlc2VudChwcm9qZWN0RGlyKTtcbiAgaWYgKHlhcm5QYXRoRnJvbUNvbmZpZyAhPT0gbnVsbCkge1xuICAgIGluZm8gPSB7YmluYXJ5OiAnbm9kZScsIGFyZ3M6IFt5YXJuUGF0aEZyb21Db25maWddfTtcbiAgfVxuXG4gIGlmICghaW5mbykge1xuICAgIGNvbnN0IHlhcm5QYXRoRnJvbU5wbUJpbiA9IGF3YWl0IGdldFlhcm5QYXRoRnJvbU5wbUdsb2JhbEJpbmFyaWVzKCk7XG4gICAgaWYgKHlhcm5QYXRoRnJvbU5wbUJpbiAhPT0gbnVsbCkge1xuICAgICAgaW5mbyA9IHtiaW5hcnk6IHlhcm5QYXRoRnJvbU5wbUJpbiwgYXJnczogW119O1xuICAgIH1cbiAgfVxuXG4gIGluZm8gPz89IHtiaW5hcnk6ICd5YXJuJywgYXJnczogW119O1xuXG4gIGNvbnN0IHlhcm5WZXJzaW9uID0gYXdhaXQgZ2V0WWFyblZlcnNpb24oaW5mbyk7XG4gIGlmICh5YXJuVmVyc2lvbiAmJiBOdW1iZXIoeWFyblZlcnNpb24uc3BsaXQoJy4nKVswXSkgPCAyKSB7XG4gICAgaW5mby5hcmdzLnB1c2goJy0tc2lsZW50Jyk7XG4gICAgaW5mby5sZWdhY3kgPSB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIGluZm87XG59XG5cbi8qKiBHZXRzIHRoZSBwYXRoIHRvIHRoZSBZYXJuIGJpbmFyeSBmcm9tIHRoZSBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0WWFyblBhdGhGcm9tTnBtR2xvYmFsQmluYXJpZXMoKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gIGNvbnN0IG5wbUdsb2JhbEJpblBhdGggPSBhd2FpdCBnZXROcG1HbG9iYWxCaW5QYXRoKCk7XG4gIGlmIChucG1HbG9iYWxCaW5QYXRoID09PSBudWxsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgd2hpY2goJ3lhcm4nLCB7cGF0aDogbnBtR2xvYmFsQmluUGF0aH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgTG9nLmRlYnVnKCdDb3VsZCBub3QgZmluZCBZYXJuIHdpdGhpbiBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuIEVycm9yOicsIGUpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKiBHZXRzIHRoZSBwYXRoIHRvIHRoZSBzeXN0ZW0td2lkZSBnbG9iYWwgTlBNIGJpbmFyeSBkaXJlY3RvcnkuICovXG5hc3luYyBmdW5jdGlvbiBnZXROcG1HbG9iYWxCaW5QYXRoKCk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgQ2hpbGRQcm9jZXNzLnNwYXduKCducG0nLCBbJ2JpbicsICctLWdsb2JhbCddLCB7bW9kZTogJ3NpbGVudCd9KSkuc3Rkb3V0LnRyaW0oKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIExvZy5kZWJ1ZygnQ291bGQgbm90IGRldGVybWluZSBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuIEVycm9yOicsIGUpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKiBHZXRzIHRoZSBZYXJuIHBhdGggZnJvbSB0aGUgWWFybiBjb25maWd1cmF0aW9uIGlmIHByZXNlbnQuICovXG5hc3luYyBmdW5jdGlvbiBnZXRZYXJuUGF0aEZyb21Db25maWd1cmF0aW9uSWZQcmVzZW50KHByb2plY3REaXI6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICBjb25zdCB5YXJuUmMgPSBhd2FpdCBmaW5kQW5kUGFyc2VZYXJuQ29uZmlndXJhdGlvbihwcm9qZWN0RGlyKTtcbiAgaWYgKHlhcm5SYyA9PT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgeWFyblBhdGggPSB5YXJuUmNbJ3lhcm4tcGF0aCddID8/IHlhcm5SY1sneWFyblBhdGgnXTtcbiAgaWYgKHlhcm5QYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBwYXRoLnJlc29sdmUocHJvamVjdERpciwgeWFyblBhdGgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRZYXJuVmVyc2lvbihpbmZvOiBZYXJuQ29tbWFuZEluZm8pOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKFxuICAgICAgYXdhaXQgQ2hpbGRQcm9jZXNzLnNwYXduKGluZm8uYmluYXJ5LCBbLi4uaW5mby5hcmdzLCAnLS12ZXJzaW9uJ10sIHttb2RlOiAnc2lsZW50J30pXG4gICAgKS5zdGRvdXQudHJpbSgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgTG9nLmRlYnVnKCdDb3VsZCBub3QgZGV0ZXJtaW5lIFlhcm4gdmVyc2lvbi4gRXJyb3I6JywgZSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqIEZpbmRzIGFuZCBwYXJzZXMgdGhlIFlhcm4gY29uZmlndXJhdGlvbiBmaWxlIGZvciB0aGUgZ2l2ZW4gcHJvamVjdC4gKi9cbmFzeW5jIGZ1bmN0aW9uIGZpbmRBbmRQYXJzZVlhcm5Db25maWd1cmF0aW9uKFxuICBwcm9qZWN0RGlyOiBzdHJpbmcsXG4pOiBQcm9taXNlPFlhcm5Db25maWd1cmF0aW9uIHwgbnVsbD4ge1xuICBjb25zdCBmaWxlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHlhcm5Db25maWdGaWxlcy5tYXAoYXN5bmMgKGVudHJ5KSA9PiAoe1xuICAgICAgZW50cnksXG4gICAgICBjb250ZW50OiBhd2FpdCByZWFkRmlsZUdyYWNlZnVsbHkocGF0aC5qb2luKHByb2plY3REaXIsIGVudHJ5LmZpbGVOYW1lKSksXG4gICAgfSkpLFxuICApO1xuICBjb25zdCBjb25maWcgPSBmaWxlcy5maW5kKChlbnRyeSkgPT4gZW50cnkuY29udGVudCAhPT0gbnVsbCk7XG4gIGlmIChjb25maWcgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gY29uZmlnLmVudHJ5LnBhcnNlKGNvbmZpZy5jb250ZW50ISk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBMb2cuZGVidWcoYENvdWxkIG5vdCBwYXJzZSBkZXRlcm1pbmVkIFlhcm4gY29uZmlndXJhdGlvbiBmaWxlICgke2NvbmZpZy5lbnRyeS5maWxlTmFtZX0pLmApO1xuICAgIExvZy5kZWJ1ZyhgRXJyb3I6YCwgZSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBSZWFkcyB0aGUgc3BlY2lmaWVkIGZpbGUgZ3JhY2VmdWxseS5cbiAqIEByZXR1cm5zIFRoZSBmaWxlIGNvbnRlbnRzLiBOdWxsIGlmIHRoZSBmaWxlIGRvZXMgbm90IGV4aXN0LlxuICovXG5hc3luYyBmdW5jdGlvbiByZWFkRmlsZUdyYWNlZnVsbHkoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0ZjgnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoaXNOb2RlSlNXcmFwcGVkRXJyb3IoZXJyb3IsIEVycm9yKSAmJiBlcnJvci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHRocm93IGVycm9yO1xuICB9XG59XG4iXX0=