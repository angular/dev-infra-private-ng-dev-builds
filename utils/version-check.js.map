{"version":3,"file":"version-check.js","sourceRoot":"","sources":["version-check.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google LLC\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport {parse as parseYaml} from 'yaml';\nimport {workspaceRelativePackageJsonPath} from './constants.js';\nimport {Log} from './logging.js';\nimport {tryGetPackageId} from '@pnpm/dependency-path';\nimport {determineRepoBaseDirFromCwd} from './repo-directory.js';\nimport {GitClient} from './git/git-client.js';\n\n/**\n * The currently executing version of ng-dev\n * Note: The placeholder will be replaced by the `pkg_npm` substitutions.\n */\nconst localVersion = `0.0.0-{SCM_HEAD_SHA}`;\n\n/** Whether ngDevVersionMiddleware verification has already occured. */\nlet verified = false;\nexport async function ngDevVersionMiddleware() {\n  // TODO(josephperrott): remove this guard against running multiple times after\n  //   https://github.com/yargs/yargs/issues/2223 is fixed\n  if (verified) {\n    return;\n  }\n  // TODO(josephperrott): Create an enforcement configuration option.\n  await verifyNgDevToolIsUpToDate(determineRepoBaseDirFromCwd());\n  verified = true;\n}\n\n/**\n * Verifies that the `ng-dev` tool is up-to-date in the workspace. The check will compare\n * the local version of the tool against the requested version in the workspace lock file.\n *\n * This check is helpful ensuring that the caretaker does not accidentally run with an older\n * local version of `ng-dev` due to not running `yarn`/`pnpm` after checking out new revisions.\n *\n * @returns a boolean indicating success or failure.\n */\nexport async function verifyNgDevToolIsUpToDate(workspacePath: string): Promise<boolean> {\n  const packageJsonPath = path.join(workspacePath, workspaceRelativePackageJsonPath);\n  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n  // If we are operating in the actual dev-infra repo, always return `true`.\n  if (packageJson.name === '@angular/build-tooling') {\n    Log.debug('Skipping ng-dev version check as this is a locally generated version.');\n    return true;\n  }\n  const expectedVersion = await getExpectedVersionFromPnpmLockUpstream();\n\n  Log.debug('Checking ng-dev version in lockfile and in the running script:');\n  Log.debug(`  Local: ${localVersion}`);\n  Log.debug(`  Expected: ${expectedVersion}`);\n\n  if (localVersion !== expectedVersion) {\n    Log.warn('  âš    Your locally installed version of the `ng-dev` tool is outdated and not');\n    Log.warn('      matching with the version in the `package.json` file.');\n    Log.warn('      Re-install the dependencies to ensure you are using the correct version.');\n    return false;\n  }\n\n  return true;\n}\n\n/** Retrieves the pnpm lock file from upstream on the primary branch and extracts the version. */\nasync function getExpectedVersionFromPnpmLockUpstream(): Promise<string> {\n  const git = await GitClient.get();\n  try {\n    const {data} = await git.github.repos.getContent({\n      repo: git.remoteConfig.name,\n      owner: git.remoteConfig.owner,\n      ref: git.remoteConfig.mainBranchName,\n      // This media type ensures requested files come back as the raw content.\n      mediaType: {format: 'application/vnd.github.raw+json'},\n      path: 'pnpm-lock.yaml',\n    });\n    if (Array.isArray(data) || data.type !== 'file') {\n      throw Error(\n        `A non-single file of content was retrieved from Github when the pnpm-lock.yaml file was requested`,\n      );\n    }\n    const lockFile = parseYaml(\n      Buffer.from(data.content, data.encoding as BufferEncoding).toString('utf-8'),\n    );\n    const importers = lockFile['importers']['.'];\n    const depEntry =\n      importers.dependencies?.['@angular/ng-dev'] ??\n      importers.devDependencies?.['@angular/ng-dev'] ??\n      importers.optionalDependencies?.['@angular/ng-dev'];\n    const packageId = tryGetPackageId(depEntry.version);\n\n    return lockFile['packages'][`@angular/ng-dev@${packageId}`].version;\n  } catch (e) {\n    Log.debug('Could not find expected ng-dev version from `pnpm-lock.yaml` file:', e);\n    return 'unknown';\n  }\n}\n"]}