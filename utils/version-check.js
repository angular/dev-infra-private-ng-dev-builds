/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as path from 'path';
import * as fs from 'fs';
import lockfile from '@yarnpkg/lockfile';
import { parse as parseYaml } from 'yaml';
import { ngDevNpmPackageName, workspaceRelativePackageJsonPath } from './constants.js';
import { Log } from './logging.js';
import { tryGetPackageId } from '@pnpm/dependency-path';
/**
 * Verifies that the `ng-dev` tool is up-to-date in the workspace. The check will compare
 * the local version of the tool against the requested version in the workspace lock file.
 *
 * This check is helpful ensuring that the caretaker does not accidentally run with an older
 * local version of `ng-dev` due to not running `yarn`/`pnpm` after checking out new revisions.
 *
 * @returns a boolean indicating success or failure.
 */
export async function verifyNgDevToolIsUpToDate(workspacePath) {
    // The placeholder will be replaced by the `pkg_npm` substitutions.
    const localVersion = `0.0.0-d325eefbf3eaa9b557bd47a7d176fbe2a10e1075`;
    const workspacePackageJsonFile = path.join(workspacePath, workspaceRelativePackageJsonPath);
    const pnpmLockFile = path.join(workspacePath, 'pnpm-lock.yaml');
    const yarnLockFile = path.join(workspacePath, 'yarn.lock');
    // TODO: Clean up this logic when fully dropping Yarn
    const isPnpmMigrated = fs.existsSync(pnpmLockFile) && !fs.existsSync(yarnLockFile);
    const expectedVersion = isPnpmMigrated
        ? getExpectedVersionFromPnpmLock(workspacePackageJsonFile, pnpmLockFile)
        : getExpectedVersionFromYarnLock(workspacePackageJsonFile, yarnLockFile);
    Log.debug(`Expecting the following ng-dev version: ${expectedVersion}`);
    if (localVersion !== expectedVersion) {
        Log.error('  âœ˜   Your locally installed version of the `ng-dev` tool is outdated and not');
        Log.error('      matching with the version in the `package.json` file.');
        Log.error('      Re-install the dependencies to ensure you are using the correct version.');
        return false;
    }
    return true;
}
function getExpectedVersionFromYarnLock(workspacePackageJsonFile, lockFilePath) {
    try {
        const packageJson = JSON.parse(fs.readFileSync(workspacePackageJsonFile, 'utf8'));
        // If we are operating in the actual dev-infra repo, always return `true`.
        if (packageJson.name === ngDevNpmPackageName) {
            return true;
        }
        const lockFileContent = fs.readFileSync(lockFilePath, 'utf8');
        let lockFileObject;
        try {
            const lockFile = lockfile.parse(lockFileContent);
            if (lockFile.type !== 'success') {
                throw Error('Unable to parse workspace lock file. Please ensure the file is valid.');
            }
            lockFileObject = lockFile.object;
        }
        catch {
            lockFileObject = parseYaml(lockFileContent);
        }
        const devInfraPkgVersion = packageJson?.dependencies?.[ngDevNpmPackageName] ??
            packageJson?.devDependencies?.[ngDevNpmPackageName] ??
            packageJson?.optionalDependencies?.[ngDevNpmPackageName];
        return lockFileObject[`${ngDevNpmPackageName}@${devInfraPkgVersion}`].version;
    }
    catch (e) {
        Log.debug('Could not find expected ng-dev version from `yarn.lock` file:', e);
        return null;
    }
}
function getExpectedVersionFromPnpmLock(workspacePackageJsonFile, lockFilePath) {
    try {
        const packageJson = JSON.parse(fs.readFileSync(workspacePackageJsonFile, 'utf8'));
        // If we are operating in the actual dev-infra repo, always return `true`.
        if (packageJson.name === ngDevNpmPackageName) {
            return true;
        }
        const lockFileContent = fs.readFileSync(lockFilePath, 'utf8');
        const lockFile = parseYaml(lockFileContent);
        const importers = lockFile['importers']['.'];
        const depEntry = importers.dependencies?.['@angular/ng-dev'] ??
            importers.devDependencies?.['@angular/ng-dev'] ??
            importers.optionalDependencies?.['@angular/ng-dev'];
        const packageId = tryGetPackageId(depEntry.version);
        return lockFile['packages'][`@angular/ng-dev@${packageId}`].version;
    }
    catch (e) {
        Log.debug('Could not find expected ng-dev version from `pnpm-lock.yaml` file:', e);
        return null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyc2lvbi1jaGVjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25nLWRldi91dGlscy92ZXJzaW9uLWNoZWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sUUFBUSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxLQUFLLElBQUksU0FBUyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBQyxtQkFBbUIsRUFBRSxnQ0FBZ0MsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDakMsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBRXREOzs7Ozs7OztHQVFHO0FBQ0gsTUFBTSxDQUFDLEtBQUssVUFBVSx5QkFBeUIsQ0FBQyxhQUFxQjtJQUNuRSxtRUFBbUU7SUFDbkUsTUFBTSxZQUFZLEdBQUcsc0JBQXNCLENBQUM7SUFDNUMsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQzVGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDaEUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFM0QscURBQXFEO0lBQ3JELE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ25GLE1BQU0sZUFBZSxHQUFHLGNBQWM7UUFDcEMs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QixDQUFDO1lBQzNDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQztZQUM5QyxTQUFTLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sU0FBUyxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFcEQsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsbUJBQW1CLFNBQVMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQ3RFLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsR0FBRyxDQUFDLEtBQUssQ0FBQyxvRUFBb0UsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTENcbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgbG9ja2ZpbGUgZnJvbSAnQHlhcm5wa2cvbG9ja2ZpbGUnO1xuaW1wb3J0IHtwYXJzZSBhcyBwYXJzZVlhbWx9IGZyb20gJ3lhbWwnO1xuaW1wb3J0IHtuZ0Rldk5wbVBhY2thZ2VOYW1lLCB3b3Jrc3BhY2VSZWxhdGl2ZVBhY2thZ2VKc29uUGF0aH0gZnJvbSAnLi9jb25zdGFudHMuanMnO1xuaW1wb3J0IHtMb2d9IGZyb20gJy4vbG9nZ2luZy5qcyc7XG5pbXBvcnQge3RyeUdldFBhY2thZ2VJZH0gZnJvbSAnQHBucG0vZGVwZW5kZW5jeS1wYXRoJztcblxuLyoqXG4gKiBWZXJpZmllcyB0aGF0IHRoZSBgbmctZGV2YCB0b29sIGlzIHVwLXRvLWRhdGUgaW4gdGhlIHdvcmtzcGFjZS4gVGhlIGNoZWNrIHdpbGwgY29tcGFyZVxuICogdGhlIGxvY2FsIHZlcnNpb24gb2YgdGhlIHRvb2wgYWdhaW5zdCB0aGUgcmVxdWVzdGVkIHZlcnNpb24gaW4gdGhlIHdvcmtzcGFjZSBsb2NrIGZpbGUuXG4gKlxuICogVGhpcyBjaGVjayBpcyBoZWxwZnVsIGVuc3VyaW5nIHRoYXQgdGhlIGNhcmV0YWtlciBkb2VzIG5vdCBhY2NpZGVudGFsbHkgcnVuIHdpdGggYW4gb2xkZXJcbiAqIGxvY2FsIHZlcnNpb24gb2YgYG5nLWRldmAgZHVlIHRvIG5vdCBydW5uaW5nIGB5YXJuYC9gcG5wbWAgYWZ0ZXIgY2hlY2tpbmcgb3V0IG5ldyByZXZpc2lvbnMuXG4gKlxuICogQHJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgc3VjY2VzcyBvciBmYWlsdXJlLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5TmdEZXZUb29sSXNVcFRvRGF0ZSh3b3Jrc3BhY2VQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgLy8gVGhlIHBsYWNlaG9sZGVyIHdpbGwgYmUgcmVwbGFjZWQgYnkgdGhlIGBwa2dfbnBtYCBzdWJzdGl0dXRpb25zLlxuICBjb25zdCBsb2NhbFZlcnNpb24gPSBgMC4wLjAte1NDTV9IRUFEX1NIQX1gO1xuICBjb25zdCB3b3Jrc3BhY2VQYWNrYWdlSnNvbkZpbGUgPSBwYXRoLmpvaW4od29ya3NwYWNlUGF0aCwgd29ya3NwYWNlUmVsYXRpdmVQYWNrYWdlSnNvblBhdGgpO1xuICBjb25zdCBwbnBtTG9ja0ZpbGUgPSBwYXRoLmpvaW4od29ya3NwYWNlUGF0aCwgJ3BucG0tbG9jay55YW1sJyk7XG4gIGNvbnN0IHlhcm5Mb2NrRmlsZSA9IHBhdGguam9pbih3b3Jrc3BhY2VQYXRoLCAneWFybi5sb2NrJyk7XG5cbiAgLy8gVE9ETzogQ2xlYW4gdXAgdGhpcyBsb2dpYyB3aGVuIGZ1bGx5IGRyb3BwaW5nIFlhcm5cbiAgY29uc3QgaXNQbnBtTWlncmF0ZWQgPSBmcy5leGlzdHNTeW5jKHBucG1Mb2NrRmlsZSkgJiYgIWZzLmV4aXN0c1N5bmMoeWFybkxvY2tGaWxlKTtcbiAgY29uc3QgZXhwZWN0ZWRWZXJzaW9uID0gaXNQbnBtTWlncmF0ZWRcbiAgICA/IGdldEV4cGVjdGVkVmVyc2lvbkZyb21QbnBtTG9jayh3b3Jrc3BhY2VQYWNrYWdlSnNvbkZpbGUsIHBucG1Mb2NrRmlsZSlcbiAgICA6IGdldEV4cGVjdGVkVmVyc2lvbkZyb21ZYXJuTG9jayh3b3Jrc3BhY2VQYWNrYWdlSnNvbkZpbGUsIHlhcm5Mb2NrRmlsZSk7XG5cbiAgTG9nLmRlYnVnKGBFeHBlY3RpbmcgdGhlIGZvbGxvd2luZyBuZy1kZXYgdmVyc2lvbjogJHtleHBlY3RlZFZlcnNpb259YCk7XG5cbiAgaWYgKGxvY2FsVmVyc2lvbiAhPT0gZXhwZWN0ZWRWZXJzaW9uKSB7XG4gICAgTG9nLmVycm9yKCcgIOKcmCAgIFlvdXIgbG9jYWxseSBpbnN0YWxsZWQgdmVyc2lvbiBvZiB0aGUgYG5nLWRldmAgdG9vbCBpcyBvdXRkYXRlZCBhbmQgbm90Jyk7XG4gICAgTG9nLmVycm9yKCcgICAgICBtYXRjaGluZyB3aXRoIHRoZSB2ZXJzaW9uIGluIHRoZSBgcGFja2FnZS5qc29uYCBmaWxlLicpO1xuICAgIExvZy5lcnJvcignICAgICAgUmUtaW5zdGFsbCB0aGUgZGVwZW5kZW5jaWVzIHRvIGVuc3VyZSB5b3UgYXJlIHVzaW5nIHRoZSBjb3JyZWN0IHZlcnNpb24uJyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGdldEV4cGVjdGVkVmVyc2lvbkZyb21ZYXJuTG9jayh3b3Jrc3BhY2VQYWNrYWdlSnNvbkZpbGU6IHN0cmluZywgbG9ja0ZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwYWNrYWdlSnNvbiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHdvcmtzcGFjZVBhY2thZ2VKc29uRmlsZSwgJ3V0ZjgnKSkgYXMgYW55O1xuICAgIC8vIElmIHdlIGFyZSBvcGVyYXRpbmcgaW4gdGhlIGFjdHVhbCBkZXYtaW5mcmEgcmVwbywgYWx3YXlzIHJldHVybiBgdHJ1ZWAuXG4gICAgaWYgKHBhY2thZ2VKc29uLm5hbWUgPT09IG5nRGV2TnBtUGFja2FnZU5hbWUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IGxvY2tGaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhsb2NrRmlsZVBhdGgsICd1dGY4Jyk7XG5cbiAgICBsZXQgbG9ja0ZpbGVPYmplY3Q6IFJlY29yZDxzdHJpbmcsIHt2ZXJzaW9uOiBzdHJpbmd9PjtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbG9ja0ZpbGUgPSBsb2NrZmlsZS5wYXJzZShsb2NrRmlsZUNvbnRlbnQpO1xuXG4gICAgICBpZiAobG9ja0ZpbGUudHlwZSAhPT0gJ3N1Y2Nlc3MnKSB7XG4gICAgICAgIHRocm93IEVycm9yKCdVbmFibGUgdG8gcGFyc2Ugd29ya3NwYWNlIGxvY2sgZmlsZS4gUGxlYXNlIGVuc3VyZSB0aGUgZmlsZSBpcyB2YWxpZC4nKTtcbiAgICAgIH1cbiAgICAgIGxvY2tGaWxlT2JqZWN0ID0gbG9ja0ZpbGUub2JqZWN0IGFzIGxvY2tmaWxlLkxvY2tGaWxlT2JqZWN0O1xuICAgIH0gY2F0Y2gge1xuICAgICAgbG9ja0ZpbGVPYmplY3QgPSBwYXJzZVlhbWwobG9ja0ZpbGVDb250ZW50KTtcbiAgICB9XG5cbiAgICBjb25zdCBkZXZJbmZyYVBrZ1ZlcnNpb24gPVxuICAgICAgcGFja2FnZUpzb24/LmRlcGVuZGVuY2llcz8uW25nRGV2TnBtUGFja2FnZU5hbWVdID8/XG4gICAgICBwYWNrYWdlSnNvbj8uZGV2RGVwZW5kZW5jaWVzPy5bbmdEZXZOcG1QYWNrYWdlTmFtZV0gPz9cbiAgICAgIHBhY2thZ2VKc29uPy5vcHRpb25hbERlcGVuZGVuY2llcz8uW25nRGV2TnBtUGFja2FnZU5hbWVdO1xuICAgIHJldHVybiBsb2NrRmlsZU9iamVjdFtgJHtuZ0Rldk5wbVBhY2thZ2VOYW1lfUAke2RldkluZnJhUGtnVmVyc2lvbn1gXS52ZXJzaW9uO1xuICB9IGNhdGNoIChlKSB7XG4gICAgTG9nLmRlYnVnKCdDb3VsZCBub3QgZmluZCBleHBlY3RlZCBuZy1kZXYgdmVyc2lvbiBmcm9tIGB5YXJuLmxvY2tgIGZpbGU6JywgZSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RXhwZWN0ZWRWZXJzaW9uRnJvbVBucG1Mb2NrKHdvcmtzcGFjZVBhY2thZ2VKc29uRmlsZTogc3RyaW5nLCBsb2NrRmlsZVBhdGg6IHN0cmluZykge1xuICB0cnkge1xuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMod29ya3NwYWNlUGFja2FnZUpzb25GaWxlLCAndXRmOCcpKSBhcyBhbnk7XG4gICAgLy8gSWYgd2UgYXJlIG9wZXJhdGluZyBpbiB0aGUgYWN0dWFsIGRldi1pbmZyYSByZXBvLCBhbHdheXMgcmV0dXJuIGB0cnVlYC5cbiAgICBpZiAocGFja2FnZUpzb24ubmFtZSA9PT0gbmdEZXZOcG1QYWNrYWdlTmFtZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgbG9ja0ZpbGVDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGxvY2tGaWxlUGF0aCwgJ3V0ZjgnKTtcbiAgICBjb25zdCBsb2NrRmlsZSA9IHBhcnNlWWFtbChsb2NrRmlsZUNvbnRlbnQpO1xuICAgIGNvbnN0IGltcG9ydGVycyA9IGxvY2tGaWxlWydpbXBvcnRlcnMnXVsnLiddO1xuICAgIGNvbnN0IGRlcEVudHJ5ID1cbiAgICAgIGltcG9ydGVycy5kZXBlbmRlbmNpZXM/LlsnQGFuZ3VsYXIvbmctZGV2J10gPz9cbiAgICAgIGltcG9ydGVycy5kZXZEZXBlbmRlbmNpZXM/LlsnQGFuZ3VsYXIvbmctZGV2J10gPz9cbiAgICAgIGltcG9ydGVycy5vcHRpb25hbERlcGVuZGVuY2llcz8uWydAYW5ndWxhci9uZy1kZXYnXTtcbiAgICBjb25zdCBwYWNrYWdlSWQgPSB0cnlHZXRQYWNrYWdlSWQoZGVwRW50cnkudmVyc2lvbik7XG5cbiAgICByZXR1cm4gbG9ja0ZpbGVbJ3BhY2thZ2VzJ11bYEBhbmd1bGFyL25nLWRldkAke3BhY2thZ2VJZH1gXS52ZXJzaW9uO1xuICB9IGNhdGNoIChlKSB7XG4gICAgTG9nLmRlYnVnKCdDb3VsZCBub3QgZmluZCBleHBlY3RlZCBuZy1kZXYgdmVyc2lvbiBmcm9tIGBwbnBtLWxvY2sueWFtbGAgZmlsZTonLCBlKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuIl19