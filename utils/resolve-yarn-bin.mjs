/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as fs from 'fs';
import * as path from 'path';
import which from 'which';
import { isNodeJSWrappedError } from './nodejs-errors.js';
import lockfile from '@yarnpkg/lockfile';
import { parse as parseYaml } from 'yaml';
import { ChildProcess } from './child-process.js';
import { Log } from './logging.js';
/** List of Yarn configuration files and their parsing mechanisms. */
export const yarnConfigFiles = [
    { fileName: '.yarnrc', parse: (c) => lockfile.parse(c).object },
    { fileName: '.yarnrc.yml', parse: (c) => parseYaml(c) },
];
/**
 * Resolves Yarn for the given project directory.
 *
 * This function exists so that Yarn can be invoked from within Yarn-initiated processes.
 * Yarn uses some magical logic where it creates a temporary directory to make Yarn resolvable.
 * This temporary directory is then wired up in `process.env.PATH` and can break for example
 * when a command switches branches, causing the originally invoked Yarn checked-in file to
 * become unavailable.
 */
export async function resolveYarnScriptForProject(projectDir) {
    const yarnPathFromConfig = await getYarnPathFromConfigurationIfPresent(projectDir);
    if (yarnPathFromConfig !== null) {
        return { binary: 'node', args: [yarnPathFromConfig] };
    }
    const yarnPathFromNpmBin = await getYarnPathFromNpmGlobalBinaries();
    if (yarnPathFromNpmBin !== null) {
        return { binary: yarnPathFromNpmBin, args: [] };
    }
    return { binary: 'yarn', args: [] };
}
/** Gets the path to the Yarn binary from the NPM global binary directory. */
export async function getYarnPathFromNpmGlobalBinaries() {
    const npmGlobalBinPath = await getNpmGlobalBinPath();
    if (npmGlobalBinPath === null) {
        return null;
    }
    try {
        return await which('yarn', { path: npmGlobalBinPath });
    }
    catch (e) {
        Log.debug('Could not find Yarn within NPM global binary directory. Error:', e);
        return null;
    }
}
/** Gets the path to the system-wide global NPM binary directory. */
async function getNpmGlobalBinPath() {
    try {
        return (await ChildProcess.spawn('npm', ['bin', '--global'], { mode: 'silent' })).stdout.trim();
    }
    catch (e) {
        Log.debug('Could not determine NPM global binary directory. Error:', e);
        return null;
    }
}
/** Gets the Yarn path from the Yarn configuration if present. */
async function getYarnPathFromConfigurationIfPresent(projectDir) {
    const yarnRc = await findAndParseYarnConfiguration(projectDir);
    if (yarnRc === null) {
        return null;
    }
    const yarnPath = yarnRc['yarn-path'] ?? yarnRc['yarnPath'];
    if (yarnPath === undefined) {
        return null;
    }
    return path.resolve(projectDir, yarnPath);
}
/** Finds and parses the Yarn configuration file for the given project. */
async function findAndParseYarnConfiguration(projectDir) {
    const files = await Promise.all(yarnConfigFiles.map(async (entry) => ({
        entry,
        content: await readFileGracefully(path.join(projectDir, entry.fileName)),
    })));
    const config = files.find((entry) => entry.content !== null);
    if (config === undefined) {
        return null;
    }
    try {
        return config.entry.parse(config.content);
    }
    catch (e) {
        Log.debug(`Could not parse determined Yarn configuration file (${config.entry.fileName}).`);
        Log.debug(`Error:`, e);
        return null;
    }
}
/**
 * Reads the specified file gracefully.
 * @returns The file contents. Null if the file does not exist.
 */
async function readFileGracefully(filePath) {
    try {
        return await fs.promises.readFile(filePath, 'utf8');
    }
    catch (error) {
        if (isNodeJSWrappedError(error, Error) && error.code === 'ENOENT') {
            return null;
        }
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZS15YXJuLWJpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25nLWRldi91dGlscy9yZXNvbHZlLXlhcm4tYmluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUUxQixPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUN4RCxPQUFPLFFBQVEsTUFBTSxtQkFBbUIsQ0FBQztBQUN6QyxPQUFPLEVBQUMsS0FBSyxJQUFJLFNBQVMsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQWlCakMscUVBQXFFO0FBQ3JFLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBdUI7SUFDakQsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUM7SUFDN0QsRUFBQyxRQUFRLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFDO0NBQ3RELENBQUM7QUFFRjs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsMkJBQTJCLENBQUMsVUFBa0I7SUFDbEUsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLHFDQUFxQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25GLElBQUksa0JBQWtCLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDaEMsT0FBTyxFQUFD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Q0FBQztJQUVELElBQUksQ0FBQztRQUNILE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQVEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsR0FBRyxDQUFDLEtBQUssQ0FBQyx1REFBdUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDO1FBQzVGLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUM7QUFFRDs7O0dBR0c7QUFDSCxLQUFLLFVBQVUsa0JBQWtCLENBQUMsUUFBZ0I7SUFDaEQsSUFBSSxDQUFDO1FBQ0gsT0FBTyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksb0JBQW9CLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDbEUsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQ0QsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHdoaWNoIGZyb20gJ3doaWNoJztcblxuaW1wb3J0IHtpc05vZGVKU1dyYXBwZWRFcnJvcn0gZnJvbSAnLi9ub2RlanMtZXJyb3JzLmpzJztcbmltcG9ydCBsb2NrZmlsZSBmcm9tICdAeWFybnBrZy9sb2NrZmlsZSc7XG5pbXBvcnQge3BhcnNlIGFzIHBhcnNlWWFtbH0gZnJvbSAneWFtbCc7XG5pbXBvcnQge0NoaWxkUHJvY2Vzc30gZnJvbSAnLi9jaGlsZC1wcm9jZXNzLmpzJztcbmltcG9ydCB7TG9nfSBmcm9tICcuL2xvZ2dpbmcuanMnO1xuXG4vKiogVHlwZSBkZXNjcmliaW5nIGEgWWFybiBjb25maWd1cmF0aW9uIGFuZCBpdHMgcG90ZW50aWFsIHByb3BlcnRpZXMuICovXG5leHBvcnQgaW50ZXJmYWNlIFlhcm5Db25maWd1cmF0aW9uIHtcbiAgJ3lhcm5QYXRoJzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAneWFybi1wYXRoJzogc3RyaW5nIHwgdW5kZWZpbmVkO1xufVxuXG4vKiogVHlwZSBkZXNjcmliaW5nIGEgY29uZmlndXJhdGlvbiB3aXRoIGl0cyBjb3JyZXNwb25kaW5nIHBhcnNpbmcgbWVjaGFuaXNtLiAqL1xuZXhwb3J0IHR5cGUgQ29uZmlnV2l0aFBhcnNlciA9IHtmaWxlTmFtZTogc3RyaW5nOyBwYXJzZTogKGM6IHN0cmluZykgPT4gWWFybkNvbmZpZ3VyYXRpb259O1xuXG4vKiogSW50ZXJmYWNlIGRlc2NyaWJpbmcgYSBjb21tYW5kIHRoYXQgd2lsbCBpbnZva2UgWWFybi4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgWWFybkNvbW1hbmRJbmZvIHtcbiAgYmluYXJ5OiBzdHJpbmc7XG4gIGFyZ3M6IHN0cmluZ1tdO1xufVxuXG4vKiogTGlzdCBvZiBZYXJuIGNvbmZpZ3VyYXRpb24gZmlsZXMgYW5kIHRoZWlyIHBhcnNpbmcgbWVjaGFuaXNtcy4gKi9cbmV4cG9ydCBjb25zdCB5YXJuQ29uZmlnRmlsZXM6IENvbmZpZ1dpdGhQYXJzZXJbXSA9IFtcbiAge2ZpbGVOYW1lOiAnLnlhcm5yYycsIHBhcnNlOiAoYykgPT4gbG9ja2ZpbGUucGFyc2UoYykub2JqZWN0fSxcbiAge2ZpbGVOYW1lOiAnLnlhcm5yYy55bWwnLCBwYXJzZTogKGMpID0+IHBhcnNlWWFtbChjKX0sXG5dO1xuXG4vKipcbiAqIFJlc29sdmVzIFlhcm4gZm9yIHRoZSBnaXZlbiBwcm9qZWN0IGRpcmVjdG9yeS5cbiAqXG4gKiBUaGlzIGZ1bmN0aW9uIGV4aXN0cyBzbyB0aGF0IFlhcm4gY2FuIGJlIGludm9rZWQgZnJvbSB3aXRoaW4gWWFybi1pbml0aWF0ZWQgcHJvY2Vzc2VzLlxuICogWWFybiB1c2VzIHNvbWUgbWFnaWNhbCBsb2dpYyB3aGVyZSBpdCBjcmVhdGVzIGEgdGVtcG9yYXJ5IGRpcmVjdG9yeSB0byBtYWtlIFlhcm4gcmVzb2x2YWJsZS5cbiAqIFRoaXMgdGVtcG9yYXJ5IGRpcmVjdG9yeSBpcyB0aGVuIHdpcmVkIHVwIGluIGBwcm9jZXNzLmVudi5QQVRIYCBhbmQgY2FuIGJyZWFrIGZvciBleGFtcGxlXG4gKiB3aGVuIGEgY29tbWFuZCBzd2l0Y2hlcyBicmFuY2hlcywgY2F1c2luZyB0aGUgb3JpZ2luYWxseSBpbnZva2VkIFlhcm4gY2hlY2tlZC1pbiBmaWxlIHRvXG4gKiBiZWNvbWUgdW5hdmFpbGFibGUuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXNvbHZlWWFyblNjcmlwdEZvclByb2plY3QocHJvamVjdERpcjogc3RyaW5nKTogUHJvbWlzZTxZYXJuQ29tbWFuZEluZm8+IHtcbiAgY29uc3QgeWFyblBhdGhGcm9tQ29uZmlnID0gYXdhaXQgZ2V0WWFyblBhdGhGcm9tQ29uZmlndXJhdGlvbklmUHJlc2VudChwcm9qZWN0RGlyKTtcbiAgaWYgKHlhcm5QYXRoRnJvbUNvbmZpZyAhPT0gbnVsbCkge1xuICAgIHJldHVybiB7YmluYXJ5OiAnbm9kZScsIGFyZ3M6IFt5YXJuUGF0aEZyb21Db25maWddfTtcbiAgfVxuXG4gIGNvbnN0IHlhcm5QYXRoRnJvbU5wbUJpbiA9IGF3YWl0IGdldFlhcm5QYXRoRnJvbU5wbUdsb2JhbEJpbmFyaWVzKCk7XG4gIGlmICh5YXJuUGF0aEZyb21OcG1CaW4gIT09IG51bGwpIHtcbiAgICByZXR1cm4ge2JpbmFyeTogeWFyblBhdGhGcm9tTnBtQmluLCBhcmdzOiBbXX07XG4gIH1cblxuICByZXR1cm4ge2JpbmFyeTogJ3lhcm4nLCBhcmdzOiBbXX07XG59XG5cbi8qKiBHZXRzIHRoZSBwYXRoIHRvIHRoZSBZYXJuIGJpbmFyeSBmcm9tIHRoZSBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0WWFyblBhdGhGcm9tTnBtR2xvYmFsQmluYXJpZXMoKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gIGNvbnN0IG5wbUdsb2JhbEJpblBhdGggPSBhd2FpdCBnZXROcG1HbG9iYWxCaW5QYXRoKCk7XG4gIGlmIChucG1HbG9iYWxCaW5QYXRoID09PSBudWxsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgd2hpY2goJ3lhcm4nLCB7cGF0aDogbnBtR2xvYmFsQmluUGF0aH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgTG9nLmRlYnVnKCdDb3VsZCBub3QgZmluZCBZYXJuIHdpdGhpbiBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuIEVycm9yOicsIGUpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKiBHZXRzIHRoZSBwYXRoIHRvIHRoZSBzeXN0ZW0td2lkZSBnbG9iYWwgTlBNIGJpbmFyeSBkaXJlY3RvcnkuICovXG5hc3luYyBmdW5jdGlvbiBnZXROcG1HbG9iYWxCaW5QYXRoKCk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgQ2hpbGRQcm9jZXNzLnNwYXduKCducG0nLCBbJ2JpbicsICctLWdsb2JhbCddLCB7bW9kZTogJ3NpbGVudCd9KSkuc3Rkb3V0LnRyaW0oKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIExvZy5kZWJ1ZygnQ291bGQgbm90IGRldGVybWluZSBOUE0gZ2xvYmFsIGJpbmFyeSBkaXJlY3RvcnkuIEVycm9yOicsIGUpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbi8qKiBHZXRzIHRoZSBZYXJuIHBhdGggZnJvbSB0aGUgWWFybiBjb25maWd1cmF0aW9uIGlmIHByZXNlbnQuICovXG5hc3luYyBmdW5jdGlvbiBnZXRZYXJuUGF0aEZyb21Db25maWd1cmF0aW9uSWZQcmVzZW50KHByb2plY3REaXI6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICBjb25zdCB5YXJuUmMgPSBhd2FpdCBmaW5kQW5kUGFyc2VZYXJuQ29uZmlndXJhdGlvbihwcm9qZWN0RGlyKTtcbiAgaWYgKHlhcm5SYyA9PT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgeWFyblBhdGggPSB5YXJuUmNbJ3lhcm4tcGF0aCddID8/IHlhcm5SY1sneWFyblBhdGgnXTtcbiAgaWYgKHlhcm5QYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBwYXRoLnJlc29sdmUocHJvamVjdERpciwgeWFyblBhdGgpO1xufVxuXG4vKiogRmluZHMgYW5kIHBhcnNlcyB0aGUgWWFybiBjb25maWd1cmF0aW9uIGZpbGUgZm9yIHRoZSBnaXZlbiBwcm9qZWN0LiAqL1xuYXN5bmMgZnVuY3Rpb24gZmluZEFuZFBhcnNlWWFybkNvbmZpZ3VyYXRpb24oXG4gIHByb2plY3REaXI6IHN0cmluZyxcbik6IFByb21pc2U8WWFybkNvbmZpZ3VyYXRpb24gfCBudWxsPiB7XG4gIGNvbnN0IGZpbGVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgeWFybkNvbmZpZ0ZpbGVzLm1hcChhc3luYyAoZW50cnkpID0+ICh7XG4gICAgICBlbnRyeSxcbiAgICAgIGNvbnRlbnQ6IGF3YWl0IHJlYWRGaWxlR3JhY2VmdWxseShwYXRoLmpvaW4ocHJvamVjdERpciwgZW50cnkuZmlsZU5hbWUpKSxcbiAgICB9KSksXG4gICk7XG4gIGNvbnN0IGNvbmZpZyA9IGZpbGVzLmZpbmQoKGVudHJ5KSA9PiBlbnRyeS5jb250ZW50ICE9PSBudWxsKTtcbiAgaWYgKGNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICB0cnkge1xuICAgIHJldHVybiBjb25maWcuZW50cnkucGFyc2UoY29uZmlnLmNvbnRlbnQhKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIExvZy5kZWJ1ZyhgQ291bGQgbm90IHBhcnNlIGRldGVybWluZWQgWWFybiBjb25maWd1cmF0aW9uIGZpbGUgKCR7Y29uZmlnLmVudHJ5LmZpbGVOYW1lfSkuYCk7XG4gICAgTG9nLmRlYnVnKGBFcnJvcjpgLCBlKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIFJlYWRzIHRoZSBzcGVjaWZpZWQgZmlsZSBncmFjZWZ1bGx5LlxuICogQHJldHVybnMgVGhlIGZpbGUgY29udGVudHMuIE51bGwgaWYgdGhlIGZpbGUgZG9lcyBub3QgZXhpc3QuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlYWRGaWxlR3JhY2VmdWxseShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmOCcpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGlmIChpc05vZGVKU1dyYXBwZWRFcnJvcihlcnJvciwgRXJyb3IpICYmIGVycm9yLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cbiJdfQ==