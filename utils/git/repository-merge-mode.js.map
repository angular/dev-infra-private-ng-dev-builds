{"version":3,"file":"repository-merge-mode.js","sourceRoot":"","sources":["repository-merge-mode.ts"],"names":[],"mappings":"AAQA,OAAO,EAAC,GAAG,EAAC,MAAM,YAAY,CAAC;AAC/B,OAAO,EAAC,sBAAsB,EAAC,MAAM,4BAA4B,CAAC;AAElE,MAAM,qBAAqB,GAAG,YAAY,CAAC;AAE3C,MAAM,CAAC,KAAK,UAAU,mBAAmB;IACvC,MAAM,GAAG,GAAG,MAAM,sBAAsB,CAAC,GAAG,EAAE,CAAC;IAE/C,MAAM,EAAC,IAAI,EAAE,UAAU,EAAC,GAAG,MAAM,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,2CAA2C,CAAC;QAC5F,KAAK,EAAE,GAAG,CAAC,YAAY,CAAC,KAAK;QAC7B,IAAI,EAAE,GAAG,CAAC,YAAY,CAAC,IAAI;KAC5B,CAAC,CAAC;IAEH,MAAM,QAAQ,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC,EAAC,aAAa,EAAC,EAAE,EAAE,CAAC,aAAa,KAAK,qBAAqB,CAAC,CAAC;IAC/F,IAAI,QAAQ,KAAK,SAAS,EAAE,CAAC;QAC3B,MAAM,KAAK,CAAC,mDAAmD,qBAAqB,EAAE,CAAC,CAAC;IAC1F,CAAC;IAGD,OAAO,QAAQ,CAAC,KAAe,CAAC;AAClC,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,gBAAgB,CAAC,KAAa;IAClD,MAAM,YAAY,GAAG,MAAM,mBAAmB,EAAE,CAAC;IACjD,IAAI,YAAY,KAAK,KAAK,EAAE,CAAC;QAC3B,GAAG,CAAC,KAAK,CACP,8FAA8F,CAC/F,CAAC;QACF,OAAO,KAAK,CAAC;IACf,CAAC;IACD,MAAM,GAAG,GAAG,MAAM,sBAAsB,CAAC,GAAG,EAAE,CAAC;IAC/C,MAAM,EAAC,UAAU,EAAE,cAAc,EAAC,GAAG,MAAM,4BAA4B,CACrE,qBAAqB,EACrB,GAAG,CACJ,CAAC;IAEF,IAAI,UAAU,KAAK,eAAe,EAAE,CAAC;QACnC,MAAM,KAAK,CACT,oBAAoB,qBAAqB,mBAAmB,UAAU,kBAAkB;YACtF,oDAAoD,CACvD,CAAC;IACJ,CAAC;IAED,IAAI,CAAC,cAAe,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,CAAC;QACrC,MAAM,KAAK,CACT,oBAAoB,qBAAqB,wCAAwC;YAC/E,GAAG,cAAe,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,KAAK,6BAA6B,CAC5E,CAAC;IACJ,CAAC;IAID,MAAM,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,sDAAsD,CAAC;QAC5E,KAAK,EAAE,GAAG,CAAC,YAAY,CAAC,KAAK;QAC7B,IAAI,EAAE,GAAG,CAAC,YAAY,CAAC,IAAI;QAC3B,UAAU,EAAE;YACV;gBACE,aAAa,EAAE,qBAAqB;gBACpC,KAAK;aACN;SACF;KACF,CAAC,CAAC;IAEH,OAAO,IAAI,CAAC;AACd,CAAC;AAED,KAAK,UAAU,4BAA4B,CAAC,GAAW,EAAE,GAA2B;IAClF,OAAO,GAAG,CAAC,MAAM,CAAC,IAAI;SACnB,iDAAiD,CAAC;QACjD,oBAAoB,EAAE,GAAG;QACzB,GAAG,EAAE,GAAG,CAAC,YAAY,CAAC,KAAK;KAC5B,CAAC;SACD,IAAI,CAAC,CAAC,EAAC,IAAI,EAAC,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC;AAC5B,CAAC","sourcesContent":["/**\n * @license\n * Copyright Google LLC\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Log} from '../logging';\nimport {AuthenticatedGitClient} from './authenticated-git-client';\n\nconst mergeModePropertyName = 'merge-mode';\n\nexport async function getCurrentMergeMode() {\n  const git = await AuthenticatedGitClient.get();\n\n  const {data: properties} = await git.github.repos.customPropertiesForReposGetRepositoryValues({\n    owner: git.remoteConfig.owner,\n    repo: git.remoteConfig.name,\n  });\n\n  const property = properties.find(({property_name}) => property_name === mergeModePropertyName);\n  if (property === undefined) {\n    throw Error(`No repository configuration value with the key: ${mergeModePropertyName}`);\n  }\n\n  // We safely case this as a string since we know that `merge-mode` is a single-select and therefore a string.\n  return property.value as string;\n}\n\nexport async function setRepoMergeMode(value: string) {\n  const currentValue = await getCurrentMergeMode();\n  if (currentValue === value) {\n    Log.debug(\n      'Skipping update of repository configuration value as it is already set to the provided value',\n    );\n    return false;\n  }\n  const git = await AuthenticatedGitClient.get();\n  const {value_type, allowed_values} = await getRepoConfigValueDefinition(\n    mergeModePropertyName,\n    git,\n  );\n\n  if (value_type !== 'single_select') {\n    throw Error(\n      `Unable to update ${mergeModePropertyName} as its type is ${value_type}, currently the ` +\n        `only supported configuration type is single_select`,\n    );\n  }\n\n  if (!allowed_values!.includes(value)) {\n    throw Error(\n      `Unable to update ${mergeModePropertyName}. The value provided must use one of: ` +\n        `${allowed_values!.join(', ')}\\nBut \"${value}\" was provided as the value`,\n    );\n  }\n\n  // All members of the github team, `team` have been assigned the custom role `Custom Property\n  // Editor` allowing their accounts to update the values the custom properties in Angular repos.\n  await git.github.repos.customPropertiesForReposCreateOrUpdateRepositoryValues({\n    owner: git.remoteConfig.owner,\n    repo: git.remoteConfig.name,\n    properties: [\n      {\n        property_name: mergeModePropertyName,\n        value,\n      },\n    ],\n  });\n\n  return true;\n}\n\nasync function getRepoConfigValueDefinition(key: string, git: AuthenticatedGitClient) {\n  return git.github.orgs\n    .customPropertiesForReposGetOrganizationDefinition({\n      custom_property_name: key,\n      org: git.remoteConfig.owner,\n    })\n    .then(({data}) => data);\n}\n"]}