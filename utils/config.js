/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { pathToFileURL } from 'url';
import { join } from 'path';
import { Log } from './logging.js';
import { getCachedConfig, setCachedConfig } from './config-cache.js';
import { determineRepoBaseDirFromCwd } from './repo-directory.js';
/**
 * The filename expected for creating the ng-dev config, without the file
 * extension to allow either a typescript or javascript file to be used.
 */
const CONFIG_FILE_PATH = '.ng-dev/config.mjs';
/**
 * The filename expected for local user config, without the file extension to allow a typescript,
 * javascript or json file to be used.
 */
const USER_CONFIG_FILE_PATH = '.ng-dev.user';
/** The local user configuration for ng-dev. */
let userConfig = null;
/**
 * Set the cached configuration object to be loaded later. Only to be used on
 * CI and test situations in which loading from the `.ng-dev/` directory is not possible.
 */
export const setConfig = setCachedConfig;
export async function getConfig(baseDirOrAssertions) {
    let cachedConfig = getCachedConfig();
    if (cachedConfig === null) {
        let baseDir;
        if (typeof baseDirOrAssertions === 'string') {
            baseDir = baseDirOrAssertions;
        }
        else {
            baseDir = determineRepoBaseDirFromCwd();
        }
        // If the global config is not defined, load it from the file system.
        // The full path to the configuration file.
        const configPath = join(baseDir, CONFIG_FILE_PATH);
        // Read the configuration and validate it before caching it for the future.
        cachedConfig = await readConfigFile(configPath);
        // Store the newly-read configuration in the cache.
        setCachedConfig(cachedConfig);
    }
    if (Array.isArray(baseDirOrAssertions)) {
        for (const assertion of baseDirOrAssertions) {
            assertion(cachedConfig);
        }
    }
    // Return a clone of the cached global config to ensure that a new instance of the config
    // is returned each time, preventing unexpected effects of modifications to the config object.
    return { ...cachedConfig, __isNgDevConfigObject: true };
}
/**
 * Get the local user configuration from the file system, returning the already loaded copy if it is
 * defined.
 *
 * @returns The user configuration object, or an empty object if no user configuration file is
 * present. The object is an untyped object as there are no required user configurations.
 */
export async function getUserConfig() {
    // If the global config is not defined, load it from the file system.
    if (userConfig === null) {
        // The full path to the configuration file.
        const configPath = join(determineRepoBaseDirFromCwd(), USER_CONFIG_FILE_PATH);
        // Set the global config object.
        userConfig = await readConfigFile(configPath, true);
    }
    // Return a clone of the user config to ensure that a new instance of the config is returned
    // each time, preventing unexpected effects of modifications to the config object.
    return { ...userConfig };
}
/** A standard error class to thrown during assertions while validating configuration. */
export class ConfigValidationError extends Error {
    constructor(message, errors = []) {
        super(message);
        this.errors = errors;
    }
}
/** Validate th configuration has been met for the ng-dev command. */
export function assertValidGithubConfig(config) {
    const errors = [];
    // Validate the github configuration.
    if (config.github === undefined) {
        errors.push(`Github repository not configured. Set the "github" option.`);
    }
    else {
        if (config.github.name === undefined) {
            errors.push(`"github.name" is not defined`);
        }
        if (config.github.owner === undefined) {
            errors.push(`"github.owner" is not defined`);
        }
    }
    if (errors.length) {
        throw new ConfigValidationError('Invalid `github` configuration', errors);
    }
}
/** Retrieve and validate the config as `CaretakerConfig`. */
export function assertValidCaretakerConfig(config) {
    if (config.caretaker === undefined) {
        throw new ConfigValidationError(`No configuration defined for "caretaker"`);
    }
}
/**
 * Resolves and reads the specified configuration file, optionally returning an empty object
 * if the configuration file cannot be read.
 */
async function readConfigFile(configPath, returnEmptyObjectOnError = false) {
    try {
        // ESM imports expect a valid URL. On Windows, the disk name causes errors like:
        // `ERR_UNSUPPORTED_ESM_URL_SCHEME: <..> Received protocol 'c:'`
        return await import(pathToFileURL(configPath).toString());
    }
    catch (e) {
        if (returnEmptyObjectOnError) {
            Log.debug(`Could not read configuration file at ${configPath}, returning empty object instead.`);
            Log.debug(e);
            return {};
        }
        Log.error(`Could not read configuration file at ${configPath}.`);
        Log.error(e);
        process.exit(1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbmctZGV2L3V0aWxzL2NvbmZpZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFFSCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sS0FBSyxDQUFDO0FBQ2xDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFHMUIsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUNqQyxPQUFPLEVBQUMsZUFBZSxFQUFFLGVBQWUsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ25FLE9BQU8sRUFBQywyQkFBMkIsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBaUVoRTs7O0dBR0c7QUFDSCxNQUFNLGdCQUFnQixHQUFHLG9CQUFvQixDQUFDO0FBRTlDOzs7R0FHRztBQUNILE1BQU0scUJBQXFCLEdBQUcsY0FBYyxDQUFDO0FBRTdDLCtDQUErQztBQUMvQyxJQUFJLFVBQVUsR0FBZ0MsSUFBSSxDQUFDO0FBRW5EOzs7R0FHRztBQUNILE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxlQUFlLENBQUM7QUFXekMsTUFBTSxDQUFDLEtBQUssVUFBVSxTQUFTLENBQUMsbUJBQTZCO0lBQzNELElBQUksWUFBWSxHQUFHLGVBQWUsRUFBRSxDQUFDO0lBRXJDLElBQUksWUFBWSxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzFCLElBQUksT0FBZSxDQUFDO1FBQ3BCLElBQUksT0FBTyxtQkFBbUIsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUM1QyxPQUFPLEdBQUcsbUJBQW1CLENBQUM7UUFDaEMsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLEdBQUcsMkJBQTJCLEVBQUUsQ0FBQztRQUMxQyxDQUFDO1FBRUQscUVBQXFFO1FBQ3JFLDJDQUEyQztRQUMzQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENB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QXdDLFVBQVUsbUNBQW1DLENBQ3RGLENBQUM7WUFDRixHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBQ0QsR0FBRyxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNqRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge3BhdGhUb0ZpbGVVUkx9IGZyb20gJ3VybCc7XG5pbXBvcnQge2pvaW59IGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQge0Fzc2VydGlvbnMsIE11bHRpcGxlQXNzZXJ0aW9uc30gZnJvbSAnLi9jb25maWctYXNzZXJ0aW9ucy5qcyc7XG5pbXBvcnQge0xvZ30gZnJvbSAnLi9sb2dnaW5nLmpzJztcbmltcG9ydCB7Z2V0Q2FjaGVkQ29uZmlnLCBzZXRDYWNoZWRDb25maWd9IGZyb20gJy4vY29uZmlnLWNhY2hlLmpzJztcbmltcG9ydCB7ZGV0ZXJtaW5lUmVwb0Jhc2VEaXJGcm9tQ3dkfSBmcm9tICcuL3JlcG8tZGlyZWN0b3J5LmpzJztcblxuLyoqXG4gKiBUeXBlIGRlc2NyaWJpbmcgYSBuZy1kZXYgY29uZmlndXJhdGlvbi5cbiAqXG4gKiBUaGlzIGlzIGEgYnJhbmRlZCB0eXBlIHRvIGVuc3VyZSB0aGF0IHdlIGNhbiBzYWZlbHkgYXNzZXJ0IGFuIG9iamVjdFxuICogYmVpbmcgYSBjb25maWcgb2JqZWN0IGluc3RlYWQgb2YgaXQgYmVpbmcgZS5nLiBhIGBQcm9taXNlYCBvYmplY3QuXG4gKi9cbmV4cG9ydCB0eXBlIE5nRGV2Q29uZmlnPFQgPSB7fT4gPSBUICYge1xuICBfX2lzTmdEZXZDb25maWdPYmplY3Q6IGJvb2xlYW47XG59O1xuXG4vKipcbiAqIERlc2NyaWJlcyB0aGUgR2l0aHViIGNvbmZpZ3VyYXRpb24gZm9yIGRldi1pbmZyYS4gVGhpcyBjb25maWd1cmF0aW9uIGlzXG4gKiB1c2VkIGZvciBBUEkgcmVxdWVzdHMsIGRldGVybWluaW5nIHRoZSB1cHN0cmVhbSByZW1vdGUsIGV0Yy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHaXRodWJDb25maWcge1xuICAvKiogT3duZXIgbmFtZSBvZiB0aGUgcmVwb3NpdG9yeS4gKi9cbiAgb3duZXI6IHN0cmluZztcbiAgLyoqIE5hbWUgb2YgdGhlIHJlcG9zaXRvcnkuICovXG4gIG5hbWU6IHN0cmluZztcbiAgLyoqIE1haW4gYnJhbmNoIG5hbWUgZm9yIHRoZSByZXBvc2l0b3J5LiAqL1xuICBtYWluQnJhbmNoTmFtZTogc3RyaW5nO1xuICAvKiogSWYgU1NIIHByb3RvY29sIHNob3VsZCBiZSB1c2VkIGZvciBnaXQgaW50ZXJhY3Rpb25zLiAqL1xuICB1c2VTc2g/OiBib29sZWFuO1xuICAvKiogV2hldGhlciB0aGUgc3BlY2lmaWVkIHJlcG9zaXRvcnkgaXMgcHJpdmF0ZS4gKi9cbiAgcHJpdmF0ZT86IGJvb2xlYW47XG4gIC8qKiBXaGV0aGVyIHRvIGRlZmF1bHQgdG8gdXNlIE5nRGV2U2VydmljZSBmb3IgYXV0aGVudGljYXRpb24uICovXG4gIHVzZU5nRGV2QXV0aFNlcnZpY2U/OiBib29sZWFuO1xufVxuXG4vKiogQ29uZmlndXJhdGlvbiBkZXNjcmliaW5nIGhvdyBmaWxlcyBhcmUgc3luY2VkIGludG8gR29vZ2xlLiAqL1xuZXhwb3J0IGludGVyZmFjZSBHb29nbGVTeW5jQ29uZmlnIHtcbiAgLyoqXG4gICAqIFBhdHRlcm5zIG1hdGNoaW5nIGZpbGVzIHdoaWNoIGFyZSBzeW5jZWQgaW50byBHb29nbGUuIFBhdHRlcm5zXG4gICAqIHNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgcHJvamVjdCBkaXJlY3RvcnkuXG4gICAqL1xuICBzeW5jZWRGaWxlUGF0dGVybnM6IHN0cmluZ1tdO1xuICAvKipcbiAgICogUGF0dGVybnMgbWF0Y2hpbmcgZmlsZXMgd2hpY2ggYXJlIG5ldmVyIHN5bmNlZCBpbnRvIEdvb2dsZS4gUGF0dGVybnNcbiAgICogc2hvdWxkIGJlIHJlbGF0aXZlIHRvIHRoZSBwcm9qZWN0IGRpcmVjdG9yeS5cbiAgICovXG4gIGFsd2F5c0V4dGVybmFsRmlsZVBhdHRlcm5zOiBzdHJpbmdbXTtcbiAgLyoqXG4gICAqIFBhdHRlcm5zIG1hdGNoaW5nIGZpbGVzIHdoaWNoIG5lZWQgdG8gYmUgc3luY2VkIHNlcGFyYXRlbHkuXG4gICAqIFBhdHRlcm5zIHNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgcHJvamVjdCBkaXJlY3RvcnkuXG4gICAqL1xuICBzZXBhcmF0ZUZpbGVQYXR0ZXJuczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FyZXRha2VyQ29uZmlnIHtcbiAgLyoqIEdpdGh1YiBxdWVyaWVzIHNob3dpbmcgYSBzbmFwc2hvdCBvZiBwdWxscy9pc3N1ZXMgY2FyZXRha2VycyBuZWVkIHRvIG1vbml0b3IuICovXG4gIGdpdGh1YlF1ZXJpZXM/OiB7bmFtZTogc3RyaW5nOyBxdWVyeTogc3RyaW5nfVtdO1xuICAvKipcbiAgICogVGhlIEdpdGh1YiBncm91cCB1c2VkIHRvIHRyYWNrIGN1cnJlbnQgY2FyZXRha2Vycy4gQSBzZWNvbmQgZ3JvdXAgaXMgYXNzdW1lZCB0byBleGlzdCB3aXRoIHRoZVxuICAgKiBuYW1lIFwiPGdyb3VwLW5hbWU+LXJvc3RlclwiIGNvbnRhaW5pbmcgYSBsaXN0IG9mIGFsbCB1c2VycyBlbGlnaWJsZSBmb3IgdGhlIGNhcmV0YWtlciBncm91cC5cbiAgICogKi9cbiAgY2FyZXRha2VyR3JvdXA/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBQcm9qZWN0LXJlbGF0aXZlIHBhdGggdG8gYSBjb25maWcgZmlsZSBkZXNjcmliaW5nIGhvdyB0aGUgcHJvamVjdCBpcyBzeW5jZWQgaW50byBHb29nbGUuXG4gICAqIFRoZSBjb25maWd1cmF0aW9uIGZpbGUgaXMgZXhwZWN0ZWQgdG8gYmUgdmFsaWQgSlNPTkMgYW5kIG1hdGNoIHtAc2VlIEdvb2dsZVN5bmNDb25maWd9LlxuICAgKi9cbiAgZzNTeW5jQ29uZmlnUGF0aD86IHN0cmluZztcbn1cblxuLyoqXG4gKiBUaGUgZmlsZW5hbWUgZXhwZWN0ZWQgZm9yIGNyZWF0aW5nIHRoZSBuZy1kZXYgY29uZmlnLCB3aXRob3V0IHRoZSBmaWxlXG4gKiBleHRlbnNpb24gdG8gYWxsb3cgZWl0aGVyIGEgdHlwZXNjcmlwdCBvciBqYXZhc2NyaXB0IGZpbGUgdG8gYmUgdXNlZC5cbiAqL1xuY29uc3QgQ09ORklHX0ZJTEVfUEFUSCA9ICcubmctZGV2L2NvbmZpZy5tanMnO1xuXG4vKipcbiAqIFRoZSBmaWxlbmFtZSBleHBlY3RlZCBmb3IgbG9jYWwgdXNlciBjb25maWcsIHdpdGhvdXQgdGhlIGZpbGUgZXh0ZW5zaW9uIHRvIGFsbG93IGEgdHlwZXNjcmlwdCxcbiAqIGphdmFzY3JpcHQgb3IganNvbiBmaWxlIHRvIGJlIHVzZWQuXG4gKi9cbmNvbnN0IFVTRVJfQ09ORklHX0ZJTEVfUEFUSCA9ICcubmctZGV2LnVzZXInO1xuXG4vKiogVGhlIGxvY2FsIHVzZXIgY29uZmlndXJhdGlvbiBmb3IgbmctZGV2LiAqL1xubGV0IHVzZXJDb25maWc6IHtba2V5OiBzdHJpbmddOiBhbnl9IHwgbnVsbCA9IG51bGw7XG5cbi8qKlxuICogU2V0IHRoZSBjYWNoZWQgY29uZmlndXJhdGlvbiBvYmplY3QgdG8gYmUgbG9hZGVkIGxhdGVyLiBPbmx5IHRvIGJlIHVzZWQgb25cbiAqIENJIGFuZCB0ZXN0IHNpdHVhdGlvbnMgaW4gd2hpY2ggbG9hZGluZyBmcm9tIHRoZSBgLm5nLWRldi9gIGRpcmVjdG9yeSBpcyBub3QgcG9zc2libGUuXG4gKi9cbmV4cG9ydCBjb25zdCBzZXRDb25maWcgPSBzZXRDYWNoZWRDb25maWc7XG5cbi8qKlxuICogR2V0IHRoZSBjb25maWd1cmF0aW9uIGZyb20gdGhlIGZpbGUgc3lzdGVtLCByZXR1cm5pbmcgdGhlIGFscmVhZHkgbG9hZGVkXG4gKiBjb3B5IGlmIGl0IGlzIGRlZmluZWQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDb25maWcoKTogUHJvbWlzZTxOZ0RldkNvbmZpZz47XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q29uZmlnKGJhc2VEaXI6IHN0cmluZyk6IFByb21pc2U8TmdEZXZDb25maWc+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbmZpZzxBIGV4dGVuZHMgTXVsdGlwbGVBc3NlcnRpb25zPihcbiAgYXNzZXJ0aW9uczogQSxcbik6IFByb21pc2U8TmdEZXZDb25maWc8QXNzZXJ0aW9uczxBPj4+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbmZpZyhiYXNlRGlyT3JBc3NlcnRpb25zPzogdW5rbm93bikge1xuICBsZXQgY2FjaGVkQ29uZmlnID0gZ2V0Q2FjaGVkQ29uZmlnKCk7XG5cbiAgaWYgKGNhY2hlZENvbmZpZyA9PT0gbnVsbCkge1xuICAgIGxldCBiYXNlRGlyOiBzdHJpbmc7XG4gICAgaWYgKHR5cGVvZiBiYXNlRGlyT3JBc3NlcnRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgYmFzZURpciA9IGJhc2VEaXJPckFzc2VydGlvbnM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGJhc2VEaXIgPSBkZXRlcm1pbmVSZXBvQmFzZURpckZyb21Dd2QoKTtcbiAgICB9XG5cbiAgICAvLyBJZiB0aGUgZ2xvYmFsIGNvbmZpZyBpcyBub3QgZGVmaW5lZCwgbG9hZCBpdCBmcm9tIHRoZSBmaWxlIHN5c3RlbS5cbiAgICAvLyBUaGUgZnVsbCBwYXRoIHRvIHRoZSBjb25maWd1cmF0aW9uIGZpbGUuXG4gICAgY29uc3QgY29uZmlnUGF0aCA9IGpvaW4oYmFzZURpciwgQ09ORklHX0ZJTEVfUEFUSCk7XG4gICAgLy8gUmVhZCB0aGUgY29uZmlndXJhdGlvbiBhbmQgdmFsaWRhdGUgaXQgYmVmb3JlIGNhY2hpbmcgaXQgZm9yIHRoZSBmdXR1cmUuXG4gICAgY2FjaGVkQ29uZmlnID0gYXdhaXQgcmVhZENvbmZpZ0ZpbGUoY29uZmlnUGF0aCk7XG5cbiAgICAvLyBTdG9yZSB0aGUgbmV3bHktcmVhZCBjb25maWd1cmF0aW9uIGluIHRoZSBjYWNoZS5cbiAgICBzZXRDYWNoZWRDb25maWcoY2FjaGVkQ29uZmlnKTtcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KGJhc2VEaXJPckFzc2VydGlvbnMpKSB7XG4gICAgZm9yIChjb25zdCBhc3NlcnRpb24gb2YgYmFzZURpck9yQXNzZXJ0aW9ucykge1xuICAgICAgYXNzZXJ0aW9uKGNhY2hlZENvbmZpZyk7XG4gICAgfVxuICB9XG5cbiAgLy8gUmV0dXJuIGEgY2xvbmUgb2YgdGhlIGNhY2hlZCBnbG9iYWwgY29uZmlnIHRvIGVuc3VyZSB0aGF0IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBjb25maWdcbiAgLy8gaXMgcmV0dXJuZWQgZWFjaCB0aW1lLCBwcmV2ZW50aW5nIHVuZXhwZWN0ZWQgZWZmZWN0cyBvZiBtb2RpZmljYXRpb25zIHRvIHRoZSBjb25maWcgb2JqZWN0LlxuICByZXR1cm4gey4uLmNhY2hlZENvbmZpZywgX19pc05nRGV2Q29uZmlnT2JqZWN0OiB0cnVlfTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGxvY2FsIHVzZXIgY29uZmlndXJhdGlvbiBmcm9tIHRoZSBmaWxlIHN5c3RlbSwgcmV0dXJuaW5nIHRoZSBhbHJlYWR5IGxvYWRlZCBjb3B5IGlmIGl0IGlzXG4gKiBkZWZpbmVkLlxuICpcbiAqIEByZXR1cm5zIFRoZSB1c2VyIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCBvciBhbiBlbXB0eSBvYmplY3QgaWYgbm8gdXNlciBjb25maWd1cmF0aW9uIGZpbGUgaXNcbiAqIHByZXNlbnQuIFRoZSBvYmplY3QgaXMgYW4gdW50eXBlZCBvYmplY3QgYXMgdGhlcmUgYXJlIG5vIHJlcXVpcmVkIHVzZXIgY29uZmlndXJhdGlvbnMuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVc2VyQ29uZmlnKCkge1xuICAvLyBJZiB0aGUgZ2xvYmFsIGNvbmZpZyBpcyBub3QgZGVmaW5lZCwgbG9hZCBpdCBmcm9tIHRoZSBmaWxlIHN5c3RlbS5cbiAgaWYgKHVzZXJDb25maWcgPT09IG51bGwpIHtcbiAgICAvLyBUaGUgZnVsbCBwYXRoIHRvIHRoZSBjb25maWd1cmF0aW9uIGZpbGUuXG4gICAgY29uc3QgY29uZmlnUGF0aCA9IGpvaW4oZGV0ZXJtaW5lUmVwb0Jhc2VEaXJGcm9tQ3dkKCksIFVTRVJfQ09ORklHX0ZJTEVfUEFUSCk7XG4gICAgLy8gU2V0IHRoZSBnbG9iYWwgY29uZmlnIG9iamVjdC5cbiAgICB1c2VyQ29uZmlnID0gYXdhaXQgcmVhZENvbmZpZ0ZpbGUoY29uZmlnUGF0aCwgdHJ1ZSk7XG4gIH1cbiAgLy8gUmV0dXJuIGEgY2xvbmUgb2YgdGhlIHVzZXIgY29uZmlnIHRvIGVuc3VyZSB0aGF0IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBjb25maWcgaXMgcmV0dXJuZWRcbiAgLy8gZWFjaCB0aW1lLCBwcmV2ZW50aW5nIHVuZXhwZWN0ZWQgZWZmZWN0cyBvZiBtb2RpZmljYXRpb25zIHRvIHRoZSBjb25maWcgb2JqZWN0LlxuICByZXR1cm4gey4uLnVzZXJDb25maWd9O1xufVxuXG4vKiogQSBzdGFuZGFyZCBlcnJvciBjbGFzcyB0byB0aHJvd24gZHVyaW5nIGFzc2VydGlvbnMgd2hpbGUgdmFsaWRhdGluZyBjb25maWd1cmF0aW9uLiAqL1xuZXhwb3J0IGNsYXNzIENvbmZpZ1ZhbGlkYXRpb25FcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgbWVzc2FnZT86IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgZXJyb3JzOiBzdHJpbmdbXSA9IFtdLFxuICApIHtcbiAgICBzdXBlcihtZXNzYWdlKTtcbiAgfVxufVxuXG4vKiogVmFsaWRhdGUgdGggY29uZmlndXJhdGlvbiBoYXMgYmVlbiBtZXQgZm9yIHRoZSBuZy1kZXYgY29tbWFuZC4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhc3NlcnRWYWxpZEdpdGh1YkNvbmZpZzxUIGV4dGVuZHMgTmdEZXZDb25maWc+KFxuICBjb25maWc6IFQgJiBQYXJ0aWFsPHtnaXRodWI6IEdpdGh1YkNvbmZpZ30+LFxuKTogYXNzZXJ0cyBjb25maWcgaXMgVCAmIHtnaXRodWI6IEdpdGh1YkNvbmZpZ30ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gIC8vIFZhbGlkYXRlIHRoZSBnaXRodWIgY29uZmlndXJhdGlvbi5cbiAgaWYgKGNvbmZpZy5naXRodWIgPT09IHVuZGVmaW5lZCkge1xuICAgIGVycm9ycy5wdXNoKGBHaXRodWIgcmVwb3NpdG9yeSBub3QgY29uZmlndXJlZC4gU2V0IHRoZSBcImdpdGh1YlwiIG9wdGlvbi5gKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoY29uZmlnLmdpdGh1Yi5uYW1lID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBcImdpdGh1Yi5uYW1lXCIgaXMgbm90IGRlZmluZWRgKTtcbiAgICB9XG4gICAgaWYgKGNvbmZpZy5naXRodWIub3duZXIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgZXJyb3JzLnB1c2goYFwiZ2l0aHViLm93bmVyXCIgaXMgbm90IGRlZmluZWRgKTtcbiAgICB9XG4gIH1cbiAgaWYgKGVycm9ycy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgQ29uZmlnVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGBnaXRodWJgIGNvbmZpZ3VyYXRpb24nLCBlcnJvcnMpO1xuICB9XG59XG5cbi8qKiBSZXRyaWV2ZSBhbmQgdmFsaWRhdGUgdGhlIGNvbmZpZyBhcyBgQ2FyZXRha2VyQ29uZmlnYC4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhc3NlcnRWYWxpZENhcmV0YWtlckNvbmZpZzxUIGV4dGVuZHMgTmdEZXZDb25maWc+KFxuICBjb25maWc6IFQgJiBQYXJ0aWFsPHtjYXJldGFrZXI6IENhcmV0YWtlckNvbmZpZ30+LFxuKTogYXNzZXJ0cyBjb25maWcgaXMgVCAmIHtjYXJldGFrZXI6IENhcmV0YWtlckNvbmZpZ30ge1xuICBpZiAoY29uZmlnLmNhcmV0YWtlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgdGhyb3cgbmV3IENvbmZpZ1ZhbGlkYXRpb25FcnJvcihgTm8gY29uZmlndXJhdGlvbiBkZWZpbmVkIGZvciBcImNhcmV0YWtlclwiYCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNvbHZlcyBhbmQgcmVhZHMgdGhlIHNwZWNpZmllZCBjb25maWd1cmF0aW9uIGZpbGUsIG9wdGlvbmFsbHkgcmV0dXJuaW5nIGFuIGVtcHR5IG9iamVjdFxuICogaWYgdGhlIGNvbmZpZ3VyYXRpb24gZmlsZSBjYW5ub3QgYmUgcmVhZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVhZENvbmZpZ0ZpbGUoY29uZmlnUGF0aDogc3RyaW5nLCByZXR1cm5FbXB0eU9iamVjdE9uRXJyb3IgPSBmYWxzZSk6IFByb21pc2U8e30+IHtcbiAgdHJ5IHtcbiAgICAvLyBFU00gaW1wb3J0cyBleHBlY3QgYSB2YWxpZCBVUkwuIE9uIFdpbmRvd3MsIHRoZSBkaXNrIG5hbWUgY2F1c2VzIGVycm9ycyBsaWtlOlxuICAgIC8vIGBFUlJfVU5TVVBQT1JURURfRVNNX1VSTF9TQ0hFTUU6IDwuLj4gUmVjZWl2ZWQgcHJvdG9jb2wgJ2M6J2BcbiAgICByZXR1cm4gYXdhaXQgaW1wb3J0KHBhdGhUb0ZpbGVVUkwoY29uZmlnUGF0aCkudG9TdHJpbmcoKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAocmV0dXJuRW1wdHlPYmplY3RPbkVycm9yKSB7XG4gICAgICBMb2cuZGVidWcoXG4gICAgICAgIGBDb3VsZCBub3QgcmVhZCBjb25maWd1cmF0aW9uIGZpbGUgYXQgJHtjb25maWdQYXRofSwgcmV0dXJuaW5nIGVtcHR5IG9iamVjdCBpbnN0ZWFkLmAsXG4gICAgICApO1xuICAgICAgTG9nLmRlYnVnKGUpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgICBMb2cuZXJyb3IoYENvdWxkIG5vdCByZWFkIGNvbmZpZ3VyYXRpb24gZmlsZSBhdCAke2NvbmZpZ1BhdGh9LmApO1xuICAgIExvZy5lcnJvcihlKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH1cbn1cbiJdfQ==