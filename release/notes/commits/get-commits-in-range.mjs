/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { gitLogFormatForParsing, parseCommitFromGitLog, } from '../../../commit-message/parse.js';
import { computeUniqueIdFromCommitMessage } from './unique-commit-id.js';
/**
 * Gets all commits the head branch contains, but the base branch does not include.
 * This follows the same semantics as Git's double-dot revision range.
 *
 * i.e. `<baseRef>..<headRef>` revision range as per Git.
 * https://git-scm.com/book/en/v2/Git-Tools-Revision-Selection.
 *
 * Branches in the Angular organization are diverging quickly due to multiple factors
 * concerning the versioning and merging. i.e. Commits are cherry-picked into branches,
 * resulting in different SHAs for each branch. Additionally, branches diverge quickly
 * because changes can be made only for specific branches (e.g. a master-only change).
 *
 * In order to allow for comparisons that follow similar semantics as Git's double-dot
 * revision range syntax, the logic re-implementing the semantics need to account for
 * the mentioned semi-diverged branches. We achieve this by excluding commits in the
 * head branch which have a similarly-named commit in the base branch. We cannot rely on
 * SHAs for determining common commits between the two branches (as explained above).
 *
 * More details can be found in the `get-commits-in-range.png` file which illustrates a
 * scenario where commits from the patch branch need to be excluded from the main branch.
 */
export function getCommitsForRangeWithDeduping(client, baseRef, headRef) {
    const commits = [];
    const commitsForHead = fetchCommitsForRevisionRange(client, `${baseRef}..${headRef}`);
    const commitsForBase = fetchCommitsForRevisionRange(client, `${headRef}..${baseRef}`);
    // Map that keeps track of commits within the base branch. Commits are
    // stored with an unique id based on the commit message. If a similarly-named
    // commit appears multiple times, the value number will reflect that.
    const knownCommitsOnlyInBase = new Map();
    for (const commit of commitsForBase) {
        const id = computeUniqueIdFromCommitMessage(commit);
        const numSimilarCommits = knownCommitsOnlyInBase.get(id) ?? 0;
        knownCommitsOnlyInBase.set(id, numSimilarCommits + 1);
    }
    for (const commit of commitsForHead) {
        const id = computeUniqueIdFromCommitMessage(commit);
        const numSimilarCommits = knownCommitsOnlyInBase.get(id) ?? 0;
        // If there is a similar commit in the base branch, the current commit in the head branch
        // needs to be skipped. We keep track of the number of similar commits so that we do not
        // accidentally "dedupe" a commit. e.g. consider a case where commit `X` lands in the
        // patch branch and next branch. Then a similar similarly named commits lands only in the
        // next branch. We would not want to omit that one as it is not part of the patch branch.
        if (numSimilarCommits > 0) {
            knownCommitsOnlyInBase.set(id, numSimilarCommits - 1);
            continue;
        }
        commits.push(commit);
    }
    return commits;
}
/** Fetches commits for the given revision range using `git log`. */
export function fetchCommitsForRevisionRange(client, revisionRange) {
    const splitDelimiter = '-------------ɵɵ------------';
    const output = client.run([
        'log',
        `--format=${gitLogFormatForParsing}${splitDelimiter}`,
        revisionRange,
    ]);
    return output.stdout
        .split(splitDelimiter)
        .filter((entry) => !!entry.trim())
        .map(santizeCommitMessage)
        .map((entry) => parseCommitFromGitLog(Buffer.from(entry, 'utf-8')));
}
/**
 * Santized a raw Github message to avoid unintended results in github rendered contexts.
 *
 * Currently sanitization does:
 *  - Removes unexpected references to users
 */
function santizeCommitMessage(content) {
    return content.replace(/ (@[A-z0-9]+) /g, ' `$1` ');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWNvbW1pdHMtaW4tcmFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9uZy1kZXYvcmVsZWFzZS9ub3Rlcy9jb21taXRzL2dldC1jb21taXRzLWluLXJhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUdILE9BQU8sRUFFTCxzQkFBc0IsRUFDdEIscUJBQXFCLEdBQ3RCLE1BQU0sa0NBQWtDLENBQUM7QUFDMUMsT0FBTyxFQUFDLGdDQUFnQyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFFdkU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBb0JHO0FBQ0gsTUFBTSxVQUFVLDhCQUE4QixDQUM1QyxNQUFpQixFQUNqQixPQUFlLEVBQ2YsT0FBZTtJQUVmLE1BQU0sT0FBTyxHQUF1QixFQUFFLENBQUM7SUFDdkMsTUFBTSxjQUFjLEdBQUcsNEJBQTRCLENBQUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxLQUFLLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDdEYsTUFBTSxjQUFjLEdBQUcsNEJBQTRCLENBQUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxLQUFLLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFFdEYsc0VBQXNFO0lBQ3RFLDZFQUE2RTtJQUM3RSxxRUFBcUU7SUFDckUsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztJQUV6RCxLQUFLLE1BQU0sTUFBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxHQUFHLGdDQUFnQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BELE1BQU0saUJBQWlCLEdBQUcsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5RCxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRCxLQUFLLE1BQU0sTUFBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxHQUFHLGdDQUFnQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BELE1BQU0saUJBQWlCLEdBQUcsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU5RCx5RkFBeUY7UUFDekYsd0ZBQXdGO1FBQ3hGLHFGQUFxRjtRQUNyRix5RkFBeUY7UUFDekYseUZBQXlGO1FBQ3pGLElBQUksaUJBQWlCLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDMUIsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxpQkFBaUIsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN0RCxTQUFTO1FBQ1gsQ0FBQztRQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxvRUFBb0U7QUFDcEUsTUFBTSxVQUFVLDRCQUE0QixDQUMxQyxNQUFpQixFQUNqQixhQUFxQjtJQUVyQixNQUFNLGNBQWMsR0FBRyw2QkFBNkIsQ0FBQztJQUNyRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO1FBQ3hCLEtBQUs7UUFDTCxZQUFZLHNCQUFzQixHQUFHLGNBQWMsRUFBRTtRQUNyRCxhQUFhO0tBQ2QsQ0FBQyxDQUFDO0lBRUgsT0FBTyxNQUFNLENBQUMsTUFBTTtTQUNqQixLQUFLLENBQUMsY0FBYyxDQUFDO1NBQ3JCLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNqQyxHQUFHLENBQUMsb0JBQW9CLENBQUM7U0FDekIsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDeEUsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBUyxvQkFBb0IsQ0FBQyxPQUFlO0lBQzNDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUN0RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTENcbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7R2l0Q2xpZW50fSBmcm9tICcuLi8uLi8uLi91dGlscy9naXQvZ2l0LWNsaWVudC5qcyc7XG5pbXBvcnQge1xuICBDb21taXRGcm9tR2l0TG9nLFxuICBnaXRMb2dGb3JtYXRGb3JQYXJzaW5nLFxuICBwYXJzZUNvbW1pdEZyb21HaXRMb2csXG59IGZyb20gJy4uLy4uLy4uL2NvbW1pdC1tZXNzYWdlL3BhcnNlLmpzJztcbmltcG9ydCB7Y29tcHV0ZVVuaXF1ZUlkRnJvbUNvbW1pdE1lc3NhZ2V9IGZyb20gJy4vdW5pcXVlLWNvbW1pdC1pZC5qcyc7XG5cbi8qKlxuICogR2V0cyBhbGwgY29tbWl0cyB0aGUgaGVhZCBicmFuY2ggY29udGFpbnMsIGJ1dCB0aGUgYmFzZSBicmFuY2ggZG9lcyBub3QgaW5jbHVkZS5cbiAqIFRoaXMgZm9sbG93cyB0aGUgc2FtZSBzZW1hbnRpY3MgYXMgR2l0J3MgZG91YmxlLWRvdCByZXZpc2lvbiByYW5nZS5cbiAqXG4gKiBpLmUuIGA8YmFzZVJlZj4uLjxoZWFkUmVmPmAgcmV2aXNpb24gcmFuZ2UgYXMgcGVyIEdpdC5cbiAqIGh0dHBzOi8vZ2l0LXNjbS5jb20vYm9vay9lbi92Mi9HaXQtVG9vbHMtUmV2aXNpb24tU2VsZWN0aW9uLlxuICpcbiAqIEJyYW5jaGVzIGluIHRoZSBBbmd1bGFyIG9yZ2FuaXphdGlvbiBhcmUgZGl2ZXJnaW5nIHF1aWNrbHkgZHVlIHRvIG11bHRpcGxlIGZhY3RvcnNcbiAqIGNvbmNlcm5pbmcgdGhlIHZlcnNpb25pbmcgYW5kIG1lcmdpbmcuIGkuZS4gQ29tbWl0cyBhcmUgY2hlcnJ5LXBpY2tlZCBpbnRvIGJyYW5jaGVzLFxuICogcmVzdWx0aW5nIGluIGRpZmZlcmVudCBTSEFzIGZvciBlYWNoIGJyYW5jaC4gQWRkaXRpb25hbGx5LCBicmFuY2hlcyBkaXZlcmdlIHF1aWNrbHlcbiAqIGJlY2F1c2UgY2hhbmdlcyBjYW4gYmUgbWFkZSBvbmx5IGZvciBzcGVjaWZpYyBicmFuY2hlcyAoZS5nLiBhIG1hc3Rlci1vbmx5IGNoYW5nZSkuXG4gKlxuICogSW4gb3JkZXIgdG8gYWxsb3cgZm9yIGNvbXBhcmlzb25zIHRoYXQgZm9sbG93IHNpbWlsYXIgc2VtYW50aWNzIGFzIEdpdCdzIGRvdWJsZS1kb3RcbiAqIHJldmlzaW9uIHJhbmdlIHN5bnRheCwgdGhlIGxvZ2ljIHJlLWltcGxlbWVudGluZyB0aGUgc2VtYW50aWNzIG5lZWQgdG8gYWNjb3VudCBmb3JcbiAqIHRoZSBtZW50aW9uZWQgc2VtaS1kaXZlcmdlZCBicmFuY2hlcy4gV2UgYWNoaWV2ZSB0aGlzIGJ5IGV4Y2x1ZGluZyBjb21taXRzIGluIHRoZVxuICogaGVhZCBicmFuY2ggd2hpY2ggaGF2ZSBhIHNpbWlsYXJseS1uYW1lZCBjb21taXQgaW4gdGhlIGJhc2UgYnJhbmNoLiBXZSBjYW5ub3QgcmVseSBvblxuICogU0hBcyBmb3IgZGV0ZXJtaW5pbmcgY29tbW9uIGNvbW1pdHMgYmV0d2VlbiB0aGUgdHdvIGJyYW5jaGVzIChhcyBleHBsYWluZWQgYWJvdmUpLlxuICpcbiAqIE1vcmUgZGV0YWlscyBjYW4gYmUgZm91bmQgaW4gdGhlIGBnZXQtY29tbWl0cy1pbi1yYW5nZS5wbmdgIGZpbGUgd2hpY2ggaWxsdXN0cmF0ZXMgYVxuICogc2NlbmFyaW8gd2hlcmUgY29tbWl0cyBmcm9tIHRoZSBwYXRjaCBicmFuY2ggbmVlZCB0byBiZSBleGNsdWRlZCBmcm9tIHRoZSBtYWluIGJyYW5jaC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldENvbW1pdHNGb3JSYW5nZVdpdGhEZWR1cGluZyhcbiAgY2xpZW50OiBHaXRDbGllbnQsXG4gIGJhc2VSZWY6IHN0cmluZyxcbiAgaGVhZFJlZjogc3RyaW5nLFxuKTogQ29tbWl0RnJvbUdpdExvZ1tdIHtcbiAgY29uc3QgY29tbWl0czogQ29tbWl0RnJvbUdpdExvZ1tdID0gW107XG4gIGNvbnN0IGNvbW1pdHNGb3JIZWFkID0gZmV0Y2hDb21taXRzRm9yUmV2aXNpb25SYW5nZShjbGllbnQsIGAke2Jhc2VSZWZ9Li4ke2hlYWRSZWZ9YCk7XG4gIGNvbnN0IGNvbW1pdHNGb3JCYXNlID0gZmV0Y2hDb21taXRzRm9yUmV2aXNpb25SYW5nZShjbGllbnQsIGAke2hlYWRSZWZ9Li4ke2Jhc2VSZWZ9YCk7XG5cbiAgLy8gTWFwIHRoYXQga2VlcHMgdHJhY2sgb2YgY29tbWl0cyB3aXRoaW4gdGhlIGJhc2UgYnJhbmNoLiBDb21taXRzIGFyZVxuICAvLyBzdG9yZWQgd2l0aCBhbiB1bmlxdWUgaWQgYmFzZWQgb24gdGhlIGNvbW1pdCBtZXNzYWdlLiBJZiBhIHNpbWlsYXJseS1uYW1lZFxuICAvLyBjb21taXQgYXBwZWFycyBtdWx0aXBsZSB0aW1lcywgdGhlIHZhbHVlIG51bWJlciB3aWxsIHJlZmxlY3QgdGhhdC5cbiAgY29uc3Qga25vd25Db21taXRzT25seUluQmFzZSA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cbiAgZm9yIChjb25zdCBjb21taXQgb2YgY29tbWl0c0ZvckJhc2UpIHtcbiAgICBjb25zdCBpZCA9IGNvbXB1dGVVbmlxdWVJZEZyb21Db21taXRNZXNzYWdlKGNvbW1pdCk7XG4gICAgY29uc3QgbnVtU2ltaWxhckNvbW1pdHMgPSBrbm93bkNvbW1pdHNPbmx5SW5CYXNlLmdldChpZCkgPz8gMDtcbiAgICBrbm93bkNvbW1pdHNPbmx5SW5CYXNlLnNldChpZCwgbnVtU2ltaWxhckNvbW1pdHMgKyAxKTtcbiAgfVxuXG4gIGZvciAoY29uc3QgY29tbWl0IG9mIGNvbW1pdHNGb3JIZWFkKSB7XG4gICAgY29uc3QgaWQgPSBjb21wdXRlVW5pcXVlSWRGcm9tQ29tbWl0TWVzc2FnZShjb21taXQpO1xuICAgIGNvbnN0IG51bVNpbWlsYXJDb21taXRzID0ga25vd25Db21taXRzT25seUluQmFzZS5nZXQoaWQpID8/IDA7XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBhIHNpbWlsYXIgY29tbWl0IGluIHRoZSBiYXNlIGJyYW5jaCwgdGhlIGN1cnJlbnQgY29tbWl0IGluIHRoZSBoZWFkIGJyYW5jaFxuICAgIC8vIG5lZWRzIHRvIGJlIHNraXBwZWQuIFdlIGtlZXAgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBzaW1pbGFyIGNvbW1pdHMgc28gdGhhdCB3ZSBkbyBub3RcbiAgICAvLyBhY2NpZGVudGFsbHkgXCJkZWR1cGVcIiBhIGNvbW1pdC4gZS5nLiBjb25zaWRlciBhIGNhc2Ugd2hlcmUgY29tbWl0IGBYYCBsYW5kcyBpbiB0aGVcbiAgICAvLyBwYXRjaCBicmFuY2ggYW5kIG5leHQgYnJhbmNoLiBUaGVuIGEgc2ltaWxhciBzaW1pbGFybHkgbmFtZWQgY29tbWl0cyBsYW5kcyBvbmx5IGluIHRoZVxuICAgIC8vIG5leHQgYnJhbmNoLiBXZSB3b3VsZCBub3Qgd2FudCB0byBvbWl0IHRoYXQgb25lIGFzIGl0IGlzIG5vdCBwYXJ0IG9mIHRoZSBwYXRjaCBicmFuY2guXG4gICAgaWYgKG51bVNpbWlsYXJDb21taXRzID4gMCkge1xuICAgICAga25vd25Db21taXRzT25seUluQmFzZS5zZXQoaWQsIG51bVNpbWlsYXJDb21taXRzIC0gMSk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBjb21taXRzLnB1c2goY29tbWl0KTtcbiAgfVxuICByZXR1cm4gY29tbWl0cztcbn1cblxuLyoqIEZldGNoZXMgY29tbWl0cyBmb3IgdGhlIGdpdmVuIHJldmlzaW9uIHJhbmdlIHVzaW5nIGBnaXQgbG9nYC4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmZXRjaENvbW1pdHNGb3JSZXZpc2lvblJhbmdlKFxuICBjbGllbnQ6IEdpdENsaWVudCxcbiAgcmV2aXNpb25SYW5nZTogc3RyaW5nLFxuKTogQ29tbWl0RnJvbUdpdExvZ1tdIHtcbiAgY29uc3Qgc3BsaXREZWxpbWl0ZXIgPSAnLS0tLS0tLS0tLS0tLcm1ybUtLS0tLS0tLS0tLS0nO1xuICBjb25zdCBvdXRwdXQgPSBjbGllbnQucnVuKFtcbiAgICAnbG9nJyxcbiAgICBgLS1mb3JtYXQ9JHtnaXRMb2dGb3JtYXRGb3JQYXJzaW5nfSR7c3BsaXREZWxpbWl0ZXJ9YCxcbiAgICByZXZpc2lvblJhbmdlLFxuICBdKTtcblxuICByZXR1cm4gb3V0cHV0LnN0ZG91dFxuICAgIC5zcGxpdChzcGxpdERlbGltaXRlcilcbiAgICAuZmlsdGVyKChlbnRyeSkgPT4gISFlbnRyeS50cmltKCkpXG4gICAgLm1hcChzYW50aXplQ29tbWl0TWVzc2FnZSlcbiAgICAubWFwKChlbnRyeSkgPT4gcGFyc2VDb21taXRGcm9tR2l0TG9nKEJ1ZmZlci5mcm9tKGVudHJ5LCAndXRmLTgnKSkpO1xufVxuXG4vKipcbiAqIFNhbnRpemVkIGEgcmF3IEdpdGh1YiBtZXNzYWdlIHRvIGF2b2lkIHVuaW50ZW5kZWQgcmVzdWx0cyBpbiBnaXRodWIgcmVuZGVyZWQgY29udGV4dHMuXG4gKlxuICogQ3VycmVudGx5IHNhbml0aXphdGlvbiBkb2VzOlxuICogIC0gUmVtb3ZlcyB1bmV4cGVjdGVkIHJlZmVyZW5jZXMgdG8gdXNlcnNcbiAqL1xuZnVuY3Rpb24gc2FudGl6ZUNvbW1pdE1lc3NhZ2UoY29udGVudDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGNvbnRlbnQucmVwbGFjZSgvIChAW0EtejAtOV0rKSAvZywgJyBgJDFgICcpO1xufVxuIl19