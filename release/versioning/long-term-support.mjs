/**
 * @license
 * Copyright Google LLC
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import semver from 'semver';
import { fetchProjectNpmPackageInfo } from './npm-registry.js';
/**
 * Number of months a major version in Angular is actively supported. See:
 * https://angular.io/guide/releases#support-policy-and-schedule.
 */
const majorActiveSupportDuration = 6;
/**
 * Number of months a major version has active long-term support. See:
 * https://angular.io/guide/releases#support-policy-and-schedule.
 */
const majorLongTermSupportDuration = 12;
/** Regular expression that matches LTS NPM dist tags. */
const ltsNpmDistTagRegex = /^v(\d+)-lts$/;
/** Finds all long-term support release trains from the specified NPM package. */
export async function fetchLongTermSupportBranchesFromNpm(config) {
    const { 'dist-tags': distTags, time } = await fetchProjectNpmPackageInfo(config);
    const today = new Date();
    const active = [];
    const inactive = [];
    // Iterate through the NPM package information and determine active/inactive LTS versions with
    // their corresponding branches. We assume that an LTS tagged version in NPM belongs to the
    // last-minor branch of a given major (i.e. we assume there are no outdated LTS NPM dist tags).
    for (const npmDistTag in distTags) {
        if (isLtsDistTag(npmDistTag)) {
            const version = semver.parse(distTags[npmDistTag]);
            const branchName = `${version.major}.${version.minor}.x`;
            const majorReleaseDate = new Date(time[`${version.major}.0.0`]);
            const ltsEndDate = computeLtsEndDateOfMajor(majorReleaseDate);
            const ltsBranch = { name: branchName, version, npmDistTag };
            // Depending on whether the LTS phase is still active, add the branch
            // to the list of active or inactive LTS branches.
            if (today <= ltsEndDate) {
                active.push(ltsBranch);
            }
            else {
                inactive.push(ltsBranch);
            }
        }
    }
    // Sort LTS branches in descending order. i.e. most recent ones first.
    active.sort((a, b) => semver.rcompare(a.version, b.version));
    inactive.sort((a, b) => semver.rcompare(a.version, b.version));
    return { active, inactive };
}
/** Gets whether the specified tag corresponds to a LTS dist tag. */
export function isLtsDistTag(tagName) {
    return ltsNpmDistTagRegex.test(tagName);
}
/**
 * Computes the date when long-term support ends for a major released at the
 * specified date.
 */
export function computeLtsEndDateOfMajor(majorReleaseDate) {
    return new Date(majorReleaseDate.getFullYear(), majorReleaseDate.getMonth() + majorActiveSupportDuration + majorLongTermSupportDuration, majorReleaseDate.getDate(), majorReleaseDate.getHours(), majorReleaseDate.getMinutes(), majorReleaseDate.getSeconds(), majorReleaseDate.getMilliseconds());
}
/** Gets the long-term support NPM dist tag for a given major version. */
export function getLtsNpmDistTagOfMajor(major) {
    // LTS versions should be tagged in NPM in the following format: `v{major}-lts`.
    return `v${major}-lts`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9uZy10ZXJtLXN1cHBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9uZy1kZXYvcmVsZWFzZS92ZXJzaW9uaW5nL2xvbmctdGVybS1zdXBwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUk1QixPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQXVCN0Q7OztHQUdHO0FBQ0gsTUFBTSwwQkFBMEIsR0FBRyxDQUFDLENBQUM7QUFFckM7OztHQUdHO0FBQ0gsTUFBTSw0QkFBNEIsR0FBRyxFQUFFLENBQUM7QUFFeEMseURBQXlEO0FBQ3pELE1BQU0sa0JBQWtCLEdBQUcsY0FBYyxDQUFDO0FBRTFDLGlGQUFpRjtBQUNqRixNQUFNLENBQUMsS0FBSyxVQUFVLG1DQUFtQyxDQUN2RCxNQUFxQjtJQUVyQixNQUFNLEVBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsR0FBRyxNQUFNLDBCQUEwQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9FLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDekIsTUFBTSxNQUFNLEdBQWdCLEVBQUUsQ0FBQztJQUMvQixNQUFNLFFBQVEsR0FBZ0IsRUFBRSxDQUFDO0lBRWpDLDhGQUE4RjtJQUM5RiwyRkFBMkY7SUFDM0YsK0ZBQStGO0lBQy9GLEtBQUssTUFBTSxVQUFVLElBQUksUUFBUSxFQUFFLENBQUM7UUFDbEMsSUFBSSxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUM3QixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBRSxDQUFDO1lBQ3BELE1BQU0sVUFBVSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUM7WUFDekQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2hFLE1BQU0sVUFBVSxHQUFHLHdCQUF3QixDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDOUQsTUFBTSxTQUFTLEdBQWMsRUFBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUMsQ0FBQztZQUNyRSxxRUFBcUU7WUFDckUsa0RBQWtEO1lBQ2xELElBQUksS0FBSyxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pCLENBQUM7aUJBQU0sQ0FBQztnQkFDTixRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzNCLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELHNFQUFzRTtJQUN0RSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzdELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFFL0QsT0FBTyxFQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUMsQ0FBQztBQUM1QixDQUFDO0FBRUQsb0VBQW9FO0FBQ3BFLE1BQU0sVUFBVSxZQUFZLENBQUMsT0FBZTtJQUMxQyxPQUFPLGtCQUFrQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUMxQyxDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsTUFBTSxVQUFVLHdCQUF3QixDQUFDLGdCQUFzQjtJQUM3RCxPQUFPLElBQUksSUFBSSxDQUNiLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxFQUM5QixnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRywwQkFBMEIsR0FBRyw0QkFBNEIsRUFDdkYsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEVBQzFCLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxFQUMzQixnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsRUFDN0IsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLEVBQzdCLGdCQUFnQixDQUFDLGVBQWUsRUFBRSxDQUNuQyxDQUFDO0FBQ0osQ0FBQztBQUVELHlFQUF5RTtBQUN6RSxNQUFNLFVBQVUsdUJBQXVCLENBQUMsS0FBYTtJQUNuRCxnRkFBZ0Y7SUFDaEYsT0FBTyxJQUFJLEtBQUssTUFBZSxDQUFDO0FBQ2xDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQ1xuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cblxuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuXG5pbXBvcnQge1JlbGVhc2VDb25maWd9IGZyb20gJy4uL2NvbmZpZy9pbmRleC5qcyc7XG5cbmltcG9ydCB7ZmV0Y2hQcm9qZWN0TnBtUGFja2FnZUluZm99IGZyb20gJy4vbnBtLXJlZ2lzdHJ5LmpzJztcblxuLyoqIFR5cGUgZGVzY3JpYmluZyBhIE5QTSBkaXN0IHRhZyBpbmRpY2F0aW5nIGxvbmctdGVybSBzdXBwb3J0LiAqL1xuZXhwb3J0IHR5cGUgTHRzTnBtRGlzdFRhZyA9IGB2JHtudW1iZXJ9LWx0c2A7XG5cbi8qKiBJbnRlcmZhY2UgZGVzY3JpYmluZyBkZXRlcm1pbmVkIExUUyBicmFuY2hlcy4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTHRzQnJhbmNoZXMge1xuICAvKiogTGlzdCBvZiBhY3RpdmUgTFRTIHZlcnNpb24gYnJhbmNoZXMuICovXG4gIGFjdGl2ZTogTHRzQnJhbmNoW107XG4gIC8qKiBMaXN0IG9mIGluYWN0aXZlIExUUyB2ZXJzaW9uIGJyYW5jaGVzLiAqL1xuICBpbmFjdGl2ZTogTHRzQnJhbmNoW107XG59XG5cbi8qKiBJbnRlcmZhY2UgZGVzY3JpYmluZyBhbiBMVFMgdmVyc2lvbiBicmFuY2guICovXG5leHBvcnQgaW50ZXJmYWNlIEx0c0JyYW5jaCB7XG4gIC8qKiBOYW1lIG9mIHRoZSBicmFuY2guICovXG4gIG5hbWU6IHN0cmluZztcbiAgLyoqIE1vc3QgcmVjZW50IHZlcnNpb24gZm9yIHRoZSBnaXZlbiBMVFMgYnJhbmNoLiAqL1xuICB2ZXJzaW9uOiBzZW12ZXIuU2VtVmVyO1xuICAvKiogTlBNIGRpc3QgdGFnIGZvciB0aGUgTFRTIHZlcnNpb24uICovXG4gIG5wbURpc3RUYWc6IEx0c05wbURpc3RUYWc7XG59XG5cbi8qKlxuICogTnVtYmVyIG9mIG1vbnRocyBhIG1ham9yIHZlcnNpb24gaW4gQW5ndWxhciBpcyBhY3RpdmVseSBzdXBwb3J0ZWQuIFNlZTpcbiAqIGh0dHBzOi8vYW5ndWxhci5pby9ndWlkZS9yZWxlYXNlcyNzdXBwb3J0LXBvbGljeS1hbmQtc2NoZWR1bGUuXG4gKi9cbmNvbnN0IG1ham9yQWN0aXZlU3VwcG9ydER1cmF0aW9uID0gNjtcblxuLyoqXG4gKiBOdW1iZXIgb2YgbW9udGhzIGEgbWFqb3IgdmVyc2lvbiBoYXMgYWN0aXZlIGxvbmctdGVybSBzdXBwb3J0LiBTZWU6XG4gKiBodHRwczovL2FuZ3VsYXIuaW8vZ3VpZGUvcmVsZWFzZXMjc3VwcG9ydC1wb2xpY3ktYW5kLXNjaGVkdWxlLlxuICovXG5jb25zdCBtYWpvckxvbmdUZXJtU3VwcG9ydER1cmF0aW9uID0gMTI7XG5cbi8qKiBSZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBtYXRjaGVzIExUUyBOUE0gZGlzdCB0YWdzLiAqL1xuY29uc3QgbHRzTnBtRGlzdFRhZ1JlZ2V4ID0gL152KFxcZCspLWx0cyQvO1xuXG4vKiogRmluZHMgYWxsIGxvbmctdGVybSBzdXBwb3J0IHJlbGVhc2UgdHJhaW5zIGZyb20gdGhlIHNwZWNpZmllZCBOUE0gcGFja2FnZS4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaExvbmdUZXJtU3VwcG9ydEJyYW5jaGVzRnJvbU5wbShcbiAgY29uZmlnOiBSZWxlYXNlQ29uZmlnLFxuKTogUHJvbWlzZTxMdHNCcmFuY2hlcz4ge1xuICBjb25zdCB7J2Rpc3QtdGFncyc6IGRpc3RUYWdzLCB0aW1lfSA9IGF3YWl0IGZldGNoUHJvamVjdE5wbVBhY2thZ2VJbmZvKGNvbmZpZyk7XG4gIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgY29uc3QgYWN0aXZlOiBMdHNCcmFuY2hbXSA9IFtdO1xuICBjb25zdCBpbmFjdGl2ZTogTHRzQnJhbmNoW10gPSBbXTtcblxuICAvLyBJdGVyYXRlIHRocm91Z2ggdGhlIE5QTSBwYWNrYWdlIGluZm9ybWF0aW9uIGFuZCBkZXRlcm1pbmUgYWN0aXZlL2luYWN0aXZlIExUUyB2ZXJzaW9ucyB3aXRoXG4gIC8vIHRoZWlyIGNvcnJlc3BvbmRpbmcgYnJhbmNoZXMuIFdlIGFzc3VtZSB0aGF0IGFuIExUUyB0YWdnZWQgdmVyc2lvbiBpbiBOUE0gYmVsb25ncyB0byB0aGVcbiAgLy8gbGFzdC1taW5vciBicmFuY2ggb2YgYSBnaXZlbiBtYWpvciAoaS5lLiB3ZSBhc3N1bWUgdGhlcmUgYXJlIG5vIG91dGRhdGVkIExUUyBOUE0gZGlzdCB0YWdzKS5cbiAgZm9yIChjb25zdCBucG1EaXN0VGFnIGluIGRpc3RUYWdzKSB7XG4gICAgaWYgKGlzTHRzRGlzdFRhZyhucG1EaXN0VGFnKSkge1xuICAgICAgY29uc3QgdmVyc2lvbiA9IHNlbXZlci5wYXJzZShkaXN0VGFnc1tucG1EaXN0VGFnXSkhO1xuICAgICAgY29uc3QgYnJhbmNoTmFtZSA9IGAke3ZlcnNpb24ubWFqb3J9LiR7dmVyc2lvbi5taW5vcn0ueGA7XG4gICAgICBjb25zdCBtYWpvclJlbGVhc2VEYXRlID0gbmV3IERhdGUodGltZVtgJHt2ZXJzaW9uLm1ham9yfS4wLjBgXSk7XG4gICAgICBjb25zdCBsdHNFbmREYXRlID0gY29tcHV0ZUx0c0VuZERhdGVPZk1ham9yKG1ham9yUmVsZWFzZURhdGUpO1xuICAgICAgY29uc3QgbHRzQnJhbmNoOiBMdHNCcmFuY2ggPSB7bmFtZTogYnJhbmNoTmFtZSwgdmVyc2lvbiwgbnBtRGlzdFRhZ307XG4gICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB0aGUgTFRTIHBoYXNlIGlzIHN0aWxsIGFjdGl2ZSwgYWRkIHRoZSBicmFuY2hcbiAgICAgIC8vIHRvIHRoZSBsaXN0IG9mIGFjdGl2ZSBvciBpbmFjdGl2ZSBMVFMgYnJhbmNoZXMuXG4gICAgICBpZiAodG9kYXkgPD0gbHRzRW5kRGF0ZSkge1xuICAgICAgICBhY3RpdmUucHVzaChsdHNCcmFuY2gpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5hY3RpdmUucHVzaChsdHNCcmFuY2gpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIFNvcnQgTFRTIGJyYW5jaGVzIGluIGRlc2NlbmRpbmcgb3JkZXIuIGkuZS4gbW9zdCByZWNlbnQgb25lcyBmaXJzdC5cbiAgYWN0aXZlLnNvcnQoKGEsIGIpID0+IHNlbXZlci5yY29tcGFyZShhLnZlcnNpb24sIGIudmVyc2lvbikpO1xuICBpbmFjdGl2ZS5zb3J0KChhLCBiKSA9PiBzZW12ZXIucmNvbXBhcmUoYS52ZXJzaW9uLCBiLnZlcnNpb24pKTtcblxuICByZXR1cm4ge2FjdGl2ZSwgaW5hY3RpdmV9O1xufVxuXG4vKiogR2V0cyB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgdGFnIGNvcnJlc3BvbmRzIHRvIGEgTFRTIGRpc3QgdGFnLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzTHRzRGlzdFRhZyh0YWdOYW1lOiBzdHJpbmcpOiB0YWdOYW1lIGlzIEx0c05wbURpc3RUYWcge1xuICByZXR1cm4gbHRzTnBtRGlzdFRhZ1JlZ2V4LnRlc3QodGFnTmFtZSk7XG59XG5cbi8qKlxuICogQ29tcHV0ZXMgdGhlIGRhdGUgd2hlbiBsb25nLXRlcm0gc3VwcG9ydCBlbmRzIGZvciBhIG1ham9yIHJlbGVhc2VkIGF0IHRoZVxuICogc3BlY2lmaWVkIGRhdGUuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlTHRzRW5kRGF0ZU9mTWFqb3IobWFqb3JSZWxlYXNlRGF0ZTogRGF0ZSk6IERhdGUge1xuICByZXR1cm4gbmV3IERhdGUoXG4gICAgbWFqb3JSZWxlYXNlRGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgIG1ham9yUmVsZWFzZURhdGUuZ2V0TW9udGgoKSArIG1ham9yQWN0aXZlU3VwcG9ydER1cmF0aW9uICsgbWFqb3JMb25nVGVybVN1cHBvcnREdXJhdGlvbixcbiAgICBtYWpvclJlbGVhc2VEYXRlLmdldERhdGUoKSxcbiAgICBtYWpvclJlbGVhc2VEYXRlLmdldEhvdXJzKCksXG4gICAgbWFqb3JSZWxlYXNlRGF0ZS5nZXRNaW51dGVzKCksXG4gICAgbWFqb3JSZWxlYXNlRGF0ZS5nZXRTZWNvbmRzKCksXG4gICAgbWFqb3JSZWxlYXNlRGF0ZS5nZXRNaWxsaXNlY29uZHMoKSxcbiAgKTtcbn1cblxuLyoqIEdldHMgdGhlIGxvbmctdGVybSBzdXBwb3J0IE5QTSBkaXN0IHRhZyBmb3IgYSBnaXZlbiBtYWpvciB2ZXJzaW9uLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEx0c05wbURpc3RUYWdPZk1ham9yKG1ham9yOiBudW1iZXIpOiBMdHNOcG1EaXN0VGFnIHtcbiAgLy8gTFRTIHZlcnNpb25zIHNob3VsZCBiZSB0YWdnZWQgaW4gTlBNIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OiBgdnttYWpvcn0tbHRzYC5cbiAgcmV0dXJuIGB2JHttYWpvcn0tbHRzYCBhcyBjb25zdDtcbn1cbiJdfQ==