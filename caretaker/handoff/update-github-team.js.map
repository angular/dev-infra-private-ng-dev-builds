{"version":3,"file":"update-github-team.js","sourceRoot":"","sources":["update-github-team.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google LLC\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Prompt} from '../../utils/prompt.js';\nimport {\n  getConfig,\n  assertValidCaretakerConfig,\n  assertValidGithubConfig,\n} from '../../utils/config.js';\n\nimport {green, Log} from '../../utils/logging.js';\nimport {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client.js';\n\n/** Update the Github caretaker group, using a prompt to obtain the new caretaker group members.  */\nexport async function updateCaretakerTeamViaPrompt() {\n  /** Caretaker specific configuration. */\n  const config = await getConfig([assertValidCaretakerConfig, assertValidGithubConfig]);\n  /** The github team name for the caretaker group. */\n  const caretakerGroup = `${config.github.name}-caretaker`;\n  /** The github team name for the group containing the repository releaser. */\n  const releaserGroup = `${config.github.name}-releaser`;\n  /** The github team name for the group containing all possible caretakers. */\n  const caretakerGroupRoster = `${config.github.name}-caretaker-roster`;\n  /** The github team name for the group containing all possible emea caretakers. */\n  const caretakerGroupEmeaRoster = `${config.github.name}-caretaker-roster-emea`;\n\n  /** A set of the current caretakers in the {@link caretakerGroup}} */\n  const current = new Set(await getGroupMembers(caretakerGroup));\n  /** A list of the team members in the {@link caretakerGroupRoster}} */\n  const roster = await getGroupMembers(caretakerGroupRoster);\n  /** A list of the team members in the {@link caretakerGroupEmeaRoster}} */\n  const emeaRoster = await getGroupMembers(caretakerGroupEmeaRoster);\n\n  if (roster.length === 0) {\n    return Log.error(`  ✘  Unable to retrieve members of the group: ${caretakerGroupRoster}`);\n  }\n\n  /** The set of users selected to be members of the caretaker group. */\n  const selected = new Set(\n    await Prompt.checkbox<string>({\n      choices: roster.map((member) => ({\n        value: member,\n        checked: current.has(member),\n      })),\n      message:\n        'Select 2 caretakers for the upcoming rotation (primary and secondary, http://go/ng-caretakers):',\n      validate: (value) => {\n        if (value.length !== 2) {\n          return 'Please select exactly 2 caretakers for the upcoming rotation.';\n        }\n        return true;\n      },\n    }),\n  );\n\n  if (config.caretaker.hasEmeaCaretaker) {\n    selected.add(\n      await Prompt.select<string>({\n        choices: emeaRoster.map((value) => ({value})),\n        message: 'Select EMEA caretaker (http://go/ng-caretaker-schedule-emea)',\n      }),\n    );\n  }\n\n  if (!(await Prompt.confirm({default: true, message: 'Are you sure?'}))) {\n    return Log.warn('  ⚠  Skipping caretaker group update.');\n  }\n\n  if (JSON.stringify(Array.from(selected).sort()) === JSON.stringify(Array.from(current).sort())) {\n    return Log.info(green('  ✔  Caretaker group already up to date.'));\n  }\n\n  try {\n    await setGithubTeam(caretakerGroup, Array.from(selected));\n    await setGithubTeam(releaserGroup, Array.from(selected));\n  } catch {\n    return Log.error('  ✘  Failed to update caretaker group.');\n  }\n  Log.info(green('  ✔  Successfully updated caretaker group'));\n}\n\n/** Retrieve the current list of members for the provided group. */\nasync function getGroupMembers(group: string) {\n  /** The authenticated GitClient instance. */\n  const git = await AuthenticatedGitClient.get();\n  try {\n    return await git.github.teams\n      .listMembersInOrg({\n        org: git.remoteConfig.owner,\n        team_slug: group,\n      })\n      .then(({data}) => data.map((member) => member.login));\n  } catch (e) {\n    Log.debug(e);\n    return [];\n  }\n}\n\nasync function setGithubTeam(group: string, members: string[]) {\n  /** The authenticated GitClient instance. */\n  const git = await AuthenticatedGitClient.get();\n  /** The full name of the group <org>/<group name>. */\n  const fullSlug = `${git.remoteConfig.owner}/${group}`;\n  /** The list of current members of the group. */\n  const current = (await getGroupMembers(group)) || [];\n  /** The list of users to be removed from the group. */\n  const removed = current.filter((login) => !members.includes(login));\n  /** Add a user to the group. */\n  const add = async (username: string) => {\n    Log.debug(`Adding ${username} to ${fullSlug}.`);\n    await git.github.teams.addOrUpdateMembershipForUserInOrg({\n      org: git.remoteConfig.owner,\n      team_slug: group,\n      username,\n      role: 'maintainer',\n    });\n  };\n  /** Remove a user from the group. */\n  const remove = async (username: string) => {\n    Log.debug(`Removing ${username} from ${fullSlug}.`);\n    await git.github.teams.removeMembershipForUserInOrg({\n      org: git.remoteConfig.owner,\n      team_slug: group,\n      username,\n    });\n  };\n\n  Log.debug(`Github Team: ${fullSlug}`);\n  Log.debug(`Current Membership: ${current.join(', ')}`);\n  Log.debug(`New Membership:     ${members.join(', ')}`);\n  Log.debug(`Removed:            ${removed.join(', ')}`);\n\n  // Add members before removing to prevent the account performing the action from removing their\n  // permissions to change the group membership early.\n  await Promise.all(members.map(add));\n  await Promise.all(removed.map(remove));\n\n  Log.debug(green(`Successfully updated ${fullSlug}`));\n}\n"]}