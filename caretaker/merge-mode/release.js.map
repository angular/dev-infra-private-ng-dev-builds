{"version":3,"file":"release.js","sourceRoot":"","sources":["release.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google LLC\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {assertValidGithubConfig, getConfig} from '../../utils/config';\nimport {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\nimport {setRepoMergeMode} from '../../utils/git/repository-merge-mode';\nimport {green, Log, red, bold} from '../../utils/logging';\n\nexport async function setMergeModeRelease() {\n  try {\n    await setRepoReleaserTeamToOnlyCurrentUser();\n    await setRepoMergeMode('release');\n    Log.info(green('  ✔  Repository is set for release'));\n  } catch (err) {\n    Log.error('  ✘  Failed to setup of repository for release');\n    if (err instanceof Error) {\n      Log.info(err.message);\n      Log.debug(err.stack);\n      return;\n    }\n    Log.info(err);\n  }\n}\n\nasync function setRepoReleaserTeamToOnlyCurrentUser() {\n  /** The authenticated GitClient instance. */\n  const git = await AuthenticatedGitClient.get();\n  /** Caretaker specific configuration. */\n  const config = await getConfig([assertValidGithubConfig]);\n  /** The github team name for the group containing the repository releaser. */\n  const group = `${config.github.name}-releaser`;\n  /** The user currently authenticated to github. */\n  const login = await git.github.users.getAuthenticated().then(({data}) => data.login);\n  /**\n   * The membership role, if any for the current user in the releaser group. A maintainer role\n   * is required to be able to modify the membership of the group.\n   */\n  const membership = await git.github.teams\n    .getMembershipForUserInOrg({\n      org: git.remoteConfig.owner,\n      team_slug: group,\n      username: login,\n    })\n    .then(\n      ({data}) => data.role,\n      () => undefined,\n    );\n\n  if (membership !== 'maintainer') {\n    Log.info(`Unable to update membership in ${bold(group)}`);\n    Log.info(`Please reach out to dev-infra for assistance.`);\n    throw '';\n  }\n\n  /** A list of the current members of the releaser group */\n  const members = new Set(\n    await git.github.teams\n      .listMembersInOrg({\n        org: git.remoteConfig.owner,\n        team_slug: group,\n      })\n      .then(({data}) => data.map(({login}) => login)),\n  );\n\n  Log.debug(`Current membership for ${group}:`);\n  for (const member of members) {\n    Log.debug(`  - ${member}`);\n  }\n\n  // Do not remove the current user.\n  members.delete(login);\n\n  await Promise.all(\n    Array.from(members).map(async (username: string) => {\n      // This check should be unnecessary, but is put in place as a second guard\n      // against accidently locking all non-admins out of updating the group.\n      if (username === login) {\n        return;\n      }\n      await git.github.teams.removeMembershipForUserInOrg({\n        org: git.remoteConfig.owner,\n        team_slug: group,\n        username,\n      });\n      Log.debug(`Removed ${username} from ${group}.`);\n    }),\n  );\n}\n"]}